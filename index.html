<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="./manifest.webmanifest?v=4">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <title>FamilyBoard ‚Äì Firebase Sync (v4)</title>
  <style>
    :root{--primary:#0ea5e9;--bg:#f6f8fb;--card:#fff;--text:#222;--muted:#6b7280;--border:#e5e7eb;
      --inset-top:env(safe-area-inset-top,0px);--inset-right:env(safe-area-inset-right,0px);
      --inset-bottom:env(safe-area-inset-bottom,0px);--inset-left:env(safe-area-inset-left,0px);}
    html,body{width:100%;max-width:100%;overflow-x:hidden;margin:0;padding:0;background:var(--bg);color:var(--text);
      -webkit-text-size-adjust:100%;box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *,*::before,*::after{box-sizing:inherit}
    header{position:sticky;top:0;z-index:10;background:var(--primary);color:#fff;
      padding:calc(8px + var(--inset-top)) 12px 8px;margin-left:calc(-8px - var(--inset-left));margin-right:calc(-8px - var(--inset-right));
      text-align:center;font-size:18px;font-weight:700}
    main{width:100%;max-width:1000px;margin:14px auto;display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:1000px){main{grid-template-columns:1.2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.05)}
    h2{margin:0 0 8px;font-size:17px} .muted{color:var(--muted)} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap} .right{margin-left:auto}
    button{cursor:pointer;border:none;background:var(--primary);color:#fff;padding:10px 12px;border-radius:10px;font-weight:600;font-size:16px}
    button.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary)}
    input[type="text"],input[type="email"],input[type="password"],input[type="time"],input[type="number"]{padding:12px;border-radius:10px;border:1px solid var(--border);font-size:16px;min-width:0}
    input[type="text"],input[type="email"],input[type="password"]{flex:1}
    ul{list-style:none;margin:8px 0 0;padding:0}
    li.item{display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);padding:8px 4px;min-width:0}
    li.item:last-child{border-bottom:none}
    li.item.done .txt{text-decoration:line-through;color:#9ca3af}
    .txt{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
    .badge-time{font-size:12px;background:#0ea5e91a;color:#0369a1;border:1px solid #bae6fd;padding:3px 8px;border-radius:999px}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
    .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    .dow{font-size:12px;text-align:center;color:#6b7280;padding:6px 0}
    .day{position:relative;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;text-align:right;min-height:52px;font-weight:600;color:#111;overflow:hidden;user-select:none;cursor:pointer}
    .day.out{color:#bbb;background:#fafafa} .day.selected{outline:2px solid var(--primary);box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    .count{position:absolute;left:6px;top:6px;font-size:11px;color:#fff;background:var(--primary);padding:2px 6px;border-radius:999px}
    .center{max-width:520px;width:92vw;margin:28px auto} .sep{height:1px;background:var(--border);margin:8px 0}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:8px;border-radius:10px;font-size:14px;margin-top:8px}
  </style>
</head>
<body>
  <header>üîÑ FamilyBoard ‚Äì Firebase Sync (v4)</header>

  <div id="login" class="center card">
    <h2>Bejelentkez√©s (Firebase Auth)</h2>
    <div class="row" style="margin-top:8px">
      <input id="email" type="email" placeholder="E-mail" autocomplete="username">
      <input id="pass" type="password" placeholder="Jelsz√≥" autocomplete="current-password">
      <button id="btnLogin">Bel√©p√©s</button>
      <button id="btnRegister" class="ghost">Regisztr√°ci√≥</button>
    </div>
    <div class="warn">Az els≈ë admin felhaszn√°l√≥t a Firebase Console-ban √©rdemes felvenni, majd a <code>users/&lt;uid&gt;</code> doksiban <code>role: "admin"</code>.</div>
  </div>

  <div id="app" hidden>
    <div class="center card" style="margin-bottom:0">
      <div class="row">
        <div>Bejelentkezve: <strong id="who"></strong> <span id="roleBadge" class="pill"></span></div>
        <button id="logout" class="ghost right">Kijelentkez√©s</button>
      </div>
    </div>

    <main>
      <section>
        <div class="card">
          <div class="cal-head">
            <button id="prev" class="ghost">‚óÄ</button>
            <h3 id="monthLabel">‚Äî</h3>
            <button id="next" class="ghost">‚ñ∂</button>
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>Teend≈ëk ‚Äì <span id="dateOut" class="muted">-</span></h2>
          <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
            <input type="text" id="taskInput" placeholder="√öj teend≈ë..." />
            <input type="time" id="taskTime" aria-label="Id≈ëpont (√≥ra:perc)" />
            <button id="addTask">Hozz√°ad√°s</button>
          </div>
          <ul id="taskList"></ul>
        </div>
      </section>

      <section>
        <div class="card">
          <h2>üõí Bev√°s√°rl√≥lista</h2>
          <div class="row" style="margin-bottom:8px">
            <input type="text" id="shopInput" placeholder="√öj t√©tel..." />
            <button id="addItem">Hozz√°ad√°s</button>
          </div>
          <ul id="shopList"></ul>
          <p class="muted">T√∂rl√©shez PIN sz√ºks√©ges (2025).</p>
        </div>

        <div id="userAdmin" class="card" hidden>
          <h2>üë§ Felhaszn√°l√≥k (admin)</h2>
          <div class="row" style="margin-bottom:8px">
            <input id="newEmail" type="email" placeholder="E-mail (√∫j felhaszn√°l√≥)" />
            <input id="newPass" type="password" placeholder="Ideiglenes jelsz√≥" />
            <select id="newRole"><option value="user">user</option><option value="admin">admin</option></select>
            <button id="addUser">Hozz√°ad√°s</button>
          </div>
          <div class="sep"></div>
          <ul id="userList"></ul>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import {{ initializeApp }} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {{ getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, setPersistence, browserLocalPersistence }} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import {{ getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, addDoc, query, where, orderBy, onSnapshot, enableIndexedDbPersistence }} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {{
      apiKey: "AIzaSyAeoxtOe5Cleasm3KdeSHP9WDR3PkU-N1I",
      authDomain: "mosas-nyilvantartas.firebaseapp.com",
      projectId: "mosas-nyilvantartas",
      storageBucket: "mosas-nyilvantartas.firebasestorage.app",
      messagingSenderId: "38259241645",
      appId: "1:38259241645:web:26070b1d0686def9f00c24"
    }};

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);
    setPersistence(auth, browserLocalPersistence);
    enableIndexedDbPersistence(db).catch(()=>{});

    let secondaryApp = null;

    const $=s=>document.querySelector(s);
    const pad=n=>String(n).padStart(2,"0");
    const ymdOf=d=>`${{d.getFullYear()}}-${{pad(d.getMonth()+1)}}-${{pad(d.getDate())}}`;
    const validTime=t=>/^([01]\d|2[0-3]):[0-5]\d$/.test(t);
    const PIN="2025"; const requirePin=(m="PIN kell a t√∂rl√©shez")=>prompt(m)===PIN;

    const loginView=$('#login'), appView=$('#app'); function show(v){{loginView.hidden=v!=='login'; appView.hidden=v!=='app';}}

    let currentUser=null, userDoc=null; const householdIdDefault="default";

    async function ensureUserDoc(user){{
      const ref=doc(db,'users',user.uid); const s=await getDoc(ref);
      if(!s.exists()){{ const p={{displayName:user.email.split('@')[0],role:'user',householdId:householdIdDefault,color:'#0ea5e9'}}; await setDoc(ref,p); return p; }}
      return s.data();
    }}

    onAuthStateChanged(auth, async (user)=>{{
      if(!user){{ show('login'); return; }}
      currentUser=user; userDoc=await ensureUserDoc(user);
      $('#who').textContent=user.email; $('#roleBadge').textContent=userDoc.role; $('#userAdmin').hidden=userDoc.role!=='admin';
      show('app'); bootApp();
    }});

    $('#btnLogin').onclick=async()=>{{ const email=$('#email').value.trim(), pass=$('#pass').value; if(!email||!pass) return alert('E-mail √©s jelsz√≥ kell.'); try{{ await signInWithEmailAndPassword(auth,email,pass); }}catch(e){{ alert('Bel√©p√©si hiba: '+e.message); }} }};
    $('#btnRegister').onclick=async()=>{{ const email=$('#email').value.trim(), pass=$('#pass').value; if(!email||!pass) return alert('E-mail √©s jelsz√≥ kell.'); try{{ await createUserWithEmailAndPassword(auth,email,pass); }}catch(e){{ alert('Regisztr√°ci√≥s hiba: '+e.message); }} }};
    $('#logout').onclick=()=>signOut(auth);

    // Admin: create user via secondary app
    $('#addUser').onclick=async()=>{{
      if(userDoc?.role!=='admin') return;
      const email=$('#newEmail').value.trim(), pass=$('#newPass').value, role=$('#newRole').value;
      if(!email||!pass) return alert('E-mail + jelsz√≥ kell.');
      try{{
        if(!secondaryApp) secondaryApp = initializeApp(firebaseConfig, 'secondary');
        const {{ getAuth: gA, createUserWithEmailAndPassword: CU, signOut: SOut }} = await import('https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js');
        const secAuth = gA(secondaryApp);
        const cred = await CU(secAuth, email, pass);
        await setDoc(doc(db,'users',cred.user.uid),{{displayName:email.split('@')[0],role,householdId:householdIdDefault,color:'#60a5fa'}});
        await SOut(secAuth).catch(()=>{{}});
        $('#newEmail').value=''; $('#newPass').value=''; alert('Felhaszn√°l√≥ l√©trehozva.');
      }}catch(e){{ alert('Hiba: '+e.message); }}
    }};

    // Calendar & tasks
    const DOW=['H','K','Sze','Cs','P','Szo','V']; const calGrid=$('#calGrid'), monthLabel=$('#monthLabel'), dateOut=$('#dateOut');
    const list=$('#taskList'), ti=$('#taskInput'), tt=$('#taskTime'), addTask=$('#addTask');
    let selected=ymdOf(new Date()), viewMonth=selected.slice(0,7)+'-01', unsubTasks=null, monthCounts={{}};
    const timeToMinutes=t=>!t||!validTime(t)?1e9:(+t.slice(0,2))*60+(+t.slice(3,5));
    const moveMonth=o=>{{const [y,m]=viewMonth.split('-').map(Number);const d=new Date(y,m-1+o,1);viewMonth=ymdOf(new Date(d.getFullYear(),d.getMonth(),1));renderCalendar();}};
    document.addEventListener('click',e=>{{if(e.target.id==='prev')moveMonth(-1); if(e.target.id==='next')moveMonth(1);}});

    async function subscribeTasksForSelected(){{
      if(unsubTasks)unsubTasks();
      const qref=query(collection(db,'households',userDoc.householdId,'tasks'), where('date','==',selected));
      unsubTasks=onSnapshot(qref,(snap)=>{{ const arr=[]; snap.forEach(s=>arr.push({{id:s.id,...s.data()}})); arr.sort((a,b)=>timeToMinutes(a.time)-timeToMinutes(b.time)); renderTaskList(arr); }});
    }}
    function renderCalendar(){{
      calGrid.innerHTML=''; DOW.forEach(d=>{{const el=document.createElement('div');el.className='dow';el.textContent=d;calGrid.appendChild(el);}});
      const [y,m]=viewMonth.split('-').map(Number); const first=new Date(y,m-1,1);
      monthLabel.textContent=`${{y}}. ${{first.toLocaleString('hu-HU',{{month:'long'}})}}`;
      const start=new Date(first), shift=(start.getDay()+6)%7; start.setDate(start.getDate()-shift);
      for(let i=0;i<42;i++){{ const d=new Date(start); d.setDate(start.getDate()+i); const ymd=ymdOf(d);
        const cell=document.createElement('div'); cell.className='day'; cell.textContent=d.getDate();
        if(d.getMonth()!==first.getMonth())cell.classList.add('out'); if(ymd===selected)cell.classList.add('selected');
        if(ymd===selected && monthCounts[ymd]!=null){{const c=document.createElement('div');c.className='count';c.textContent=monthCounts[ymd]===0?'‚úì':monthCounts[ymd];cell.appendChild(c);}}
        cell.onclick=()=>{{selected=ymd; renderCalendar(); dateOut.textContent=selected; subscribeTasksForSelected();}};
        calGrid.appendChild(cell);
      }}
    }}
    function renderTaskList(arr){{
      monthCounts[selected]=arr.filter(x=>!x.done).length; renderCalendar();
      dateOut.textContent=selected; list.innerHTML='';
      if(!arr.length){{const p=document.createElement('p');p.textContent='Nincs teend≈ë.';p.className='muted';list.appendChild(p);return;}}
      for(const t of arr){{ const li=document.createElement('li'); li.className='item'+(t.done?' done':'');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=t.done; cb.onchange=async()=>{{await updateDoc(doc(db,'households',userDoc.householdId,'tasks',t.id),{{done:!t.done}});}};
        const tm=document.createElement('span'); tm.className='badge-time'; tm.textContent=t.time?`üïí ${{t.time}}`:'‚Äî';
        const ed=document.createElement('button'); ed.textContent='‚úèÔ∏è'; ed.className='ghost'; ed.onclick=async()=>{{const nv=prompt('Id≈ë (HH:MM, √ºres = nincs)', t.time||''); if(nv===null)return; if(nv!=='' && !validTime(nv))return alert('√ârv√©nytelen id≈ë.'); await updateDoc(doc(db,'households',userDoc.householdId,'tasks',t.id),{{time:nv}});}};
        const tx=document.createElement('span'); tx.className='txt'; tx.textContent=t.text;
        const right=document.createElement('span'); right.className='right';
        const del=document.createElement('button'); del.className='ghost'; del.textContent='üóëÔ∏è'; del.onclick=async()=>{{if(!requirePin())return; await deleteDoc(doc(db,'households',userDoc.householdId,'tasks',t.id));}};
        li.append(cb,tm,ed,tx,right,del); list.appendChild(li);
      }}
    }}
    addTask.onclick=async()=>{{ const text=$('#taskInput').value.trim(); let time=$('#taskTime').value.trim(); if(!text)return; if(time&& !validTime(time))return alert('√ârv√©nytelen id≈ë (HH:MM)');
      await addDoc(collection(db,'households',userDoc.householdId,'tasks'),{{text, time: time||"", done:false, date:selected, ownerUid: currentUser.uid, createdAt: Date.now()}});
      $('#taskInput').value=''; $('#taskTime').value=''; }};

    // Shopping
    const shopList=$('#shopList'), shopInput=$('#shopInput'), addItem=$('#addItem'); let unsubShopping=null;
    function subscribeShopping(){{ if(unsubShopping)unsubShopping(); const qref=query(collection(db,'households',userDoc.householdId,'shopping'), orderBy('createdAt','asc'));
      unsubShopping=onSnapshot(qref,(snap)=>{{ const arr=[]; snap.forEach(s=>arr.push({{id:s.id,...s.data()}})); renderShopping(arr); }}); }}
    function renderShopping(items){{ shopList.innerHTML=''; if(!items.length){{const p=document.createElement('p');p.textContent='√úres bev√°s√°rl√≥lista.';p.className='muted';shopList.appendChild(p);return;}}
      items.forEach(i=>{{ const li=document.createElement('li'); li.className='item'+(i.done?' done':''); const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=i.done; cb.onchange=async()=>{{await updateDoc(doc(db,'households',userDoc.householdId,'shopping',i.id),{{done:!i.done}});}};
        const tx=document.createElement('span'); tx.className='txt'; tx.textContent=i.text; const del=document.createElement('button'); del.className='ghost'; del.textContent='üóëÔ∏è'; del.onclick=async()=>{{if(!requirePin())return; await deleteDoc(doc(db,'households',userDoc.householdId,'shopping',i.id));}};
        li.append(cb,tx,del); shopList.appendChild(li); }}); }}
    addItem.onclick=async()=>{{ const text=shopInput.value.trim(); if(!text)return; await addDoc(collection(db,'households',userDoc.householdId,'shopping'),{{text,done:false,createdBy:currentUser.uid,createdAt:Date.now()}}); shopInput.value=''; }};

    function bootApp(){{ renderCalendar(); subscribeTasksForSelected(); subscribeShopping(); renderUsersList(); }}

    // Admin: list Firestore users
    async function renderUsersList(){{
      const panel=document.getElementById('userAdmin'); panel.hidden = userDoc?.role!=='admin';
      const ul=document.getElementById('userList'); if(!ul) return; ul.innerHTML='';
      if(panel.hidden) return;
      // Simple query: list all users (NOTE: requires 50+ users? pagination not handled here)
      const usersSnap = await import('https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js').then(m=>m.getDocs? m : null);
      // lightweight inline fetch using onSnapshot would need collection import; to keep it simple use getDocs via dynamic import
      const {{ getDocs }} = await import('https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js');
      const col = collection(db,'users'); const snap = await getDocs(col);
      snap.forEach(s=>{{
        const u=s.data(); const li=document.createElement('li'); li.className='item';
        const name=document.createElement('span'); name.textContent=u.displayName || '‚Äî';
        const mail=document.createElement('span'); mail.className='muted'; mail.textContent=' ('+ (u.email||'Auth felhaszn√°l√≥') +')';
        const role=document.createElement('span'); role.className='pill'; role.textContent=u.role;
        li.append(name, mail, role); ul.appendChild(li);
      }});
    }}
  </script>
</body>
</html>
