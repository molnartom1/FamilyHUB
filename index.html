<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FamilyHub • Napi Kör — Családi PWA</title>
  <meta name="description" content="Családi irányítópult + közös naptár, offline-first PWA, opcionális Google Calendar szinkronhoz előkészítve." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%230bb'/%3E%3Cpath d='M32 72c8-20 56-20 64 0-4 20-60 20-64 0z' fill='%23fff'/%3E%3Ccircle cx='48' cy='52' r='8' fill='%23fff'/%3E%3Ccircle cx='80' cy='52' r='8' fill='%23fff'/%3E%3C/svg%3E" />
  <style>
    :root{--bg:#0b1020;--card:#121a2f;--muted:#8aa1c0;--text:#e6eefb;--accent:#4cc9f0;--accent2:#b5179e;--ok:#2bd576;--warn:#f0c419;--danger:#ff5d6c}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji';background:linear-gradient(180deg,#0b1020,#0e1530);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:rgba(11,16,32,.8);backdrop-filter:blur(8px);border-bottom:1px solid #1f2a44;z-index:10}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px}
    .brand h1{font-size:18px;margin:0}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 300px}
    .card{background:linear-gradient(180deg,#121a2f,#0f182d);border:1px solid #1f2a44;border-radius:16px;padding:16px;box-shadow:0 2px 24px rgba(0,0,0,.25)}
    .muted{color:var(--muted)}
    button,.btn{background:linear-gradient(180deg,#1a2442,#152039);border:1px solid #2a3a62;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{border-color:#4cc9f0}
    input,select,textarea{width:100%;background:#0e1530;border:1px solid #243357;color:var(--text);padding:10px;border-radius:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .tab{padding:10px 12px;border-radius:999px;background:#111a31;border:1px solid #25345a;cursor:pointer;color:#b7c6e3}
    .tab.active{background:linear-gradient(180deg,#182346,#141f3b);color:#fff;border-color:#4cc9f0}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#111a31;border:1px solid #25345a;color:#9fb2d6}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;gap:10px;background:#0f1730;border:1px solid #25345a;padding:10px;border-radius:12px}
    .item input[type=checkbox]{transform:scale(1.2)}
    .tag{padding:2px 8px;border-radius:999px;border:1px solid #334770;color:#c9defb;background:#0b142c;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .footer{margin:24px 0;color:#7f93bb;font-size:12px;text-align:center}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .hidden{display:none !important}
    .divider{height:1px;background:#22345f;margin:12px 0;border:0}
    .avatar{width:24px;height:24px;border-radius:50%;display:inline-block}
    .color{appearance:none;width:44px;height:32px;border-radius:8px;border:1px solid #25406f;background:transparent}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;background:#0b142c;border:1px solid #2b426e;padding:2px 6px;border-radius:6px}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-cell{background:#0f1730;border:1px solid #25345a;border-radius:10px;padding:8px;min-height:80px}
    .cal-cell .d{font-size:12px;color:#93abd4}
    .cal-evt{margin-top:6px;font-size:12px;padding:4px 6px;border:1px solid #34568a;border-radius:8px;background:#0b142c}
    .toast{position:fixed;bottom:16px;right:16px;background:#0f1730;border:1px solid #27406b;padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .net{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2b3e67}
    .net.online{background:#0f2a2a;border-color:#1f5f5f;color:#b6fff2}
    .net.offline{background:#2a0f0f;border-color:#5f1f1f;color:#ffd6d6}
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 16px;">
      <div class="brand">
        <img class="logo" alt="logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%230bb'/%3E%3Cpath d='M32 72c8-20 56-20 64 0-4 20-60 20-64 0z' fill='%23fff'/%3E%3Ccircle cx='48' cy='52' r='8' fill='%23fff'/%3E%3Ccircle cx='80' cy='52' r='8' fill='%23fff'/%3E%3C/svg%3E" />
        <h1>FamilyHub • Napi Kör</h1>
      </div>
      <div class="inline">
        <span class="pill"><span id="familyNameLabel">Család</span></span>
        <span id="netBadge" class="net">ellenőrzés…</span>
        <button id="installBtn" class="btn">Telepítés (PWA)</button>
        <button id="notifBtn" class="btn">Értesítések bekapcsolása</button>
        <button id="exportBtn" class="btn">Export / Mentés</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div class="tabs" id="tabs"></div>
      <div id="view-dashboard" class="view"></div>
      <div id="view-calendar" class="view hidden"></div>
      <div id="view-tasks" class="view hidden"></div>
      <div id="view-shopping" class="view hidden"></div>
      <div id="view-wall" class="view hidden"></div>
      <div id="view-settings" class="view hidden"></div>
    </div>
    <div class="footer">Offline-first PWA • ICS import/export • Opcionális Google Calendar szinkron előkészítve • Helyi értesítések + Web Push (beta) • <span class="muted">Hibrid offline: App Shell + Offline fallback</span></div>
  </main>

  <template id="tpl-dashboard">
    <div class="row">
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 8px">Mai teendők</h3>
          <div id="dash-tasks"></div>
          <div class="divider"></div>
          <div class="inline" style="gap:8px">
            <input id="newTaskTitle" placeholder="Új teendő..." />
            <button id="addTaskBtn">Hozzáadás</button>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 8px">Közelgő események</h3>
          <div id="dash-events"></div>
          <div class="divider"></div>
          <div class="grid">
            <div>
              <label>Cím</label>
              <input id="evtTitle" placeholder="Pl. Orvos, szülői, edzés" />
            </div>
            <div>
              <label>Dátum</label>
              <input id="evtDate" type="date" />
            </div>
            <div>
              <label>Kezdés</label>
              <input id="evtStart" type="time" />
            </div>
            <div>
              <label>Vége</label>
              <input id="evtEnd" type="time" />
            </div>
            <div>
              <label>Megjegyzés</label>
              <input id="evtNote" placeholder="Opció" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="addEvtBtn">Esemény hozzáadása</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-calendar">
    <div class="inline" style="justify-content:space-between;width:100%">
      <div class="inline">
        <button id="prevMonth">◀</button>
        <div class="pill" id="monthLabel">2025-10</div>
        <button id="nextMonth">▶</button>
      </div>
      <div class="inline">
        <button id="icsExport">ICS export</button>
        <label class="btn" for="icsImportFile">ICS import</label>
        <input id="icsImportFile" type="file" accept=".ics,text/calendar" class="hidden" />
        <button id="gcalSync" title="Google Calendar szinkron (opcionális)">Google szinkron (beta)</button>
      </div>
    </div>
    <div class="calendar" id="calGrid"></div>
  </template>

  <template id="tpl-tasks">
    <div class="inline" style="justify-content:space-between;width:100%">
      <div class="pill">Összes teendő</div>
      <div class="inline">
        <select id="taskFilter">
          <option value="all">Mind</option>
          <option value="open">Nyitott</option>
          <option value="done">Kész</option>
        </select>
        <button id="clearDone">Kész elemek törlése</button>
      </div>
    </div>
    <div class="divider"></div>
    <div class="inline" style="gap:8px;margin-bottom:8px">
      <input id="taskTitle" placeholder="Teendő címe" />
      <select id="taskAssignee"></select>
      <button id="taskAdd">Hozzáadás</button>
    </div>
    <div id="taskList" class="list"></div>
  </template>

  <template id="tpl-shopping">
    <div class="inline" style="gap:8px;margin-bottom:8px">
      <input id="shopTitle" placeholder="Tétel (pl. tej)" />
      <input id="shopQty" placeholder="Mennyiség (pl. 2)" style="max-width:120px" />
      <select id="shopCat">
        <option>Élelmiszer</option>
        <option>Háztartás</option>
        <option>Gyerek</option>
        <option>Egyéb</option>
      </select>
      <button id="shopAdd">Hozzáadás</button>
      <button id="shopClearBought">Megvett törlése</button>
    </div>
    <div id="shopList" class="list"></div>
  </template>

  <template id="tpl-wall">
    <div class="inline" style="gap:8px;margin-bottom:8px">
      <input id="wallMsg" placeholder="Üzenj a családnak..." />
      <button id="wallSend">Küldés</button>
    </div>
    <div id="wallFeed" class="list"></div>
  </template>

  <template id="tpl-settings">
    <div class="grid">
      <div class="card">
        <h3>Család beállítások</h3>
        <label>Család neve</label>
        <input id="familyName" placeholder="Pl. Kovács család" />
        <div class="divider"></div>
        <h4>Tagok</h4>
        <div id="members"></div>
        <div class="inline" style="gap:8px;margin-top:8px">
          <input id="memberName" placeholder="Új családtag neve" />
          <input id="memberEmoji" placeholder="Emoji (pl. 😀)" style="max-width:120px" />
          <input id="memberColor" type="color" class="color" value="#4cc9f0"/>
          <button id="addMember">Hozzáadás</button>
        </div>
      </div>
      <div class="card">
        <h3>Szinkron & értesítések</h3>
        <p class="muted">Google Calendar szinkron (beta):
          <br/><span class="kbd">Bejelentkezés → naptár kiválasztás → egyirányú import</span>
        </p>
        <button id="btnGoogleSignIn">Google bejelentkezés (demo)</button>
        <button id="btnGoogleImport">Google naptár import (demo)</button>
        <div class="divider"></div>
        <p class="muted">Web Push előkészítés (szerver szükséges VAPID kulccsal). Helyi értesítések működnek.</p>
        <button id="btnTestNotify">Teszt értesítés</button>
        <div class="divider"></div>
        <h4>Web Push (beta)</h4>
        <div class="inline" style="gap:8px;flex-wrap:wrap">
          <button id="btnPushEnable">Push engedélyezés</button>
          <button id="btnPushDisable">Push leiratkozás</button>
          <button id="btnPushTest">Push teszt (szerver)</button>
        </div>
        <div class="divider"></div>
        <h4>Diagnosztika</h4>
        <div class="inline" style="gap:8px;flex-wrap:wrap">
          <button id="btnTestSW">Service Worker teszt</button>
          <button id="btnSelfTestICS">ICS körteszt</button>
          <button id="btnOpenOfflineTest">Offline fallback teszt</button>
          <button id="btnUnregSW" class="btn">SW eltávolítás</button>
          <button id="btnClearCaches" class="btn">Cache ürítés</button>
          <button id="btnFactoryReset" class="btn" title="SW + cache + adatok törlése">Gyári visszaállítás</button>
        </div>
        <small class="muted">Ha a vászon (blob: URL) miatt nincs SW, futtasd localhoston vagy https alatt. A fenti gombok segítenek egy elrontott cache/SW állapotot helyrehozni.</small>
      </div>
    </div>
  </template>

  <div id="toast" class="toast hidden"></div>

  <script>
  // --- Védett indítás + hibaoverlay ---
  (function(){
    function showOverlay(msg){
      var o=document.getElementById('fatal');
      if(!o){o=document.createElement('div');o.id='fatal';o.style.cssText='position:fixed;inset:0;background:rgba(10,0,25,.9);color:#fff;z-index:99999;padding:20px;overflow:auto;font:14px/1.4 system-ui';document.body.appendChild(o);} 
      o.innerHTML='<h2>Hiba a betöltéskor</h2><pre style="white-space:pre-wrap">'+msg+'</pre><button onclick="this.parentNode.remove()" style="margin-top:10px;padding:8px 12px;border-radius:8px;border:1px solid #34568a;background:#152039;color:#fff">Bezár</button>';
    }
    window.addEventListener('error', function(e){ showOverlay(e.message+'\n'+(e.filename||'')+':'+(e.lineno||'')); });
    window.addEventListener('unhandledrejection', function(e){ showOverlay('Unhandled promise: '+ (e.reason&&e.reason.stack||e.reason||'ismeretlen')); });
    window.__FHUB_DEBUG_OVERLAY__=showOverlay;
  })();

  const App = (function(){
    const state = {
      family: { id: 'family-001', name: 'Család', members: [
        { id: 'm1', name: 'Anya', emoji: '👩', color: '#ff5d6c'},
        { id: 'm2', name: 'Apa', emoji: '👨', color: '#4cc9f0'}
      ]},
      tasks: [], shopping: [], wall: [], events: [], monthOffset: 0
    };

    // utils
    function $(sel){ return document.querySelector(sel); }
    function el(tag, attrs, children){ attrs=attrs||{}; children=children||[]; var n=document.createElement(tag);
      Object.keys(attrs).forEach(function(k){ var v=attrs[k]; if(k==='class') n.className=v; else if(k==='html') n.innerHTML=v; else if(k.indexOf('on')===0) n.addEventListener(k.slice(2), v); else n.setAttribute(k,v); });
      children.forEach(function(c){ n.append(c); }); return n; }
    function genId(pfx){ pfx=pfx||'id'; return pfx+Math.random().toString(36).slice(2,9); }
    function toast(msg){ var t=$('#toast'); if(!t) return; t.textContent=msg; t.classList.remove('hidden'); setTimeout(function(){ t.classList.add('hidden'); }, 2400); }
    function save(){ try{ localStorage.setItem('familyhub.data', JSON.stringify(state)); }catch(e){} }
    function load(){ try{ var raw=localStorage.getItem('familyhub.data'); if(raw){ var obj=JSON.parse(raw); Object.assign(state, obj); } }catch(e){ console.warn('Load failed', e); } }

    // network badge
    function updateNet(){ var b=$('#netBadge'); if(!b) return; if(navigator.onLine){ b.textContent='online'; b.classList.add('online'); b.classList.remove('offline'); } else { b.textContent='offline'; b.classList.add('offline'); b.classList.remove('online'); } }
    addEventListener('online', updateNet); addEventListener('offline', updateNet);

    // notifications
    function ensureNotifications(){ if(!('Notification' in window)) { toast('Nincs értesítés támogatás.'); return Promise.resolve(false); } try{ if(Notification.permission==='granted') return Promise.resolve(true); return Notification.requestPermission().then(function(p){ return p==='granted'; }); }catch(e){ return Promise.resolve(false); } }
    function notifyLocal(title, body){ try{ if('Notification' in window && Notification.permission==='granted') new Notification(title, { body: body }); }catch(e){} toast(body); try{ if(navigator.serviceWorker && navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'notify', title:title, body:body}); } }catch(e){} }

    // tabs
    var tabs=[{id:'dashboard',name:'Irányítópult'},{id:'calendar',name:'Naptár'},{id:'tasks',name:'Teendők'},{id:'shopping',name:'Bevásárló'},{id:'wall',name:'Üzenőfal'},{id:'settings',name:'Beállítások'}];
    function renderTabs(active){ active=active||'dashboard'; var wrap=$('#tabs'); if(!wrap) return; wrap.innerHTML=''; tabs.forEach(function(t){ wrap.append(el('button',{class:'tab'+(t.id===active?' active':''),onclick:function(){switchView(t.id);}},[t.name])); }); }
    function switchView(view){ Array.prototype.forEach.call(document.querySelectorAll('.view'), function(v){ v.classList.add('hidden'); }); var tgt=$('#view-'+view); if(tgt) tgt.classList.remove('hidden'); renderTabs(view); var map={dashboard:renderDashboard,calendar:renderCalendar,tasks:renderTasks,shopping:renderShopping,wall:renderWall,settings:renderSettings}; if(map[view]) map[view](); }

    // dashboard
    function memberPill(mid){ var m=state.family.members.find(function(x){return x.id===mid;}); return m? '<span class="tag" style="border-color:'+m.color+';">'+(m.emoji||'👤')+' '+m.name+'</span>':'<span class="tag">Ismeretlen</span>'; }
    function renderDashboard(){ var root=$('#view-dashboard'); if(!root) return; root.innerHTML=$('#tpl-dashboard').innerHTML; var open=state.tasks.filter(function(t){return !t.done;}).slice(0,5); var list=el('div',{class:'list'}); open.forEach(function(t){ var it=el('div',{class:'item'}); var chk=el('input',{type:'checkbox',onchange:function(){t.done=true; save(); renderDashboard(); notifyLocal('Teendő kész',t.title);}}); var meta=el('div',{},[el('div',{html:'<strong>'+t.title+'</strong>'}), el('div',{class:'muted',html:memberPill(t.assignee)+' • '+new Date(t.created).toLocaleString()})]); it.append(chk,meta); list.append(it); }); var anchor=document.getElementById('dash-tasks'); if(anchor) anchor.replaceWith(list);
      var now=new Date(); var in7=new Date(now.getTime()+7*86400000); var up=state.events.filter(function(e){return new Date(e.start)<=in7 && new Date(e.end||e.start)>=now;}).sort(function(a,b){return new Date(a.start)-new Date(b.start);}).slice(0,5); var evWrap=el('div',{class:'list'}); up.forEach(function(e){ var it=el('div',{class:'item'}); it.append(el('div',{class:'tag',html:new Date(e.start).toLocaleString()}), el('div',{html:'<strong>'+e.title+'</strong> <span class="muted">'+(e.note? '• '+e.note:'')+'</span>'})); evWrap.append(it); }); var evAnchor=document.getElementById('dash-events'); if(evAnchor) evAnchor.replaceWith(evWrap);
      document.getElementById('addTaskBtn').onclick=function(){ var v=document.getElementById('newTaskTitle').value.trim(); if(!v) return; var a=state.family.members[0]? state.family.members[0].id : null; state.tasks.unshift({id:genId('t'), title:v, assignee:a, done:false, created:Date.now()}); save(); renderDashboard(); notifyLocal('Új teendő',v); document.getElementById('newTaskTitle').value=''; };
      document.getElementById('addEvtBtn').onclick=function(){ var title=document.getElementById('evtTitle').value.trim(); var date=document.getElementById('evtDate').value; var s=document.getElementById('evtStart').value; var e=document.getElementById('evtEnd').value; var note=document.getElementById('evtNote').value.trim(); if(!title||!date){ toast('Cím és dátum kötelező'); return; } var start=new Date(date+'T'+(s||'09:00')+':00'); var end=new Date(date+'T'+(e||s||'10:00')+':00'); state.events.push({id:genId('e'),title:title,start:start,end:end,note:note}); save(); renderDashboard(); notifyLocal('Új esemény', title+' • '+start.toLocaleString()); document.getElementById('evtTitle').value=''; document.getElementById('evtNote').value=''; };
    }

    // calendar
    function monthStart(o){ var d=new Date(); d.setDate(1); d.setMonth(d.getMonth()+o); return d; }
    function daysInMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); }
    function renderCalendar(){ var root=$('#view-calendar'); if(!root) return; root.innerHTML=$('#tpl-calendar').innerHTML; var base=monthStart(state.monthOffset); var y=base.getFullYear(), m=base.getMonth(); document.getElementById('monthLabel').textContent=base.toLocaleString('hu-HU',{month:'long',year:'numeric'}); var grid=document.getElementById('calGrid'); grid.innerHTML=''; var first=(new Date(y,m,1).getDay()||7)-1; for(var i=0;i<first;i++) grid.append(el('div',{class:'cal-cell muted'})); var days=daysInMonth(base); for(var d=1; d<=days; d++){ var cell=el('div',{class:'cal-cell'}); var dt=new Date(y,m,d); cell.append(el('div',{class:'d',html:dt.toLocaleDateString('hu-HU',{weekday:'short'})+' • '+d})); var todays=state.events.filter(function(e){return new Date(e.start).toDateString()===dt.toDateString();}); todays.forEach(function(ev){ cell.append(el('div',{class:'cal-evt', html:'<strong>'+ev.title+'</strong><br/><span class="muted">'+new Date(ev.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})+(ev.end?'–'+new Date(ev.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}):'')+'</span>'})); }); grid.append(cell); }
      document.getElementById('prevMonth').onclick=function(){state.monthOffset--; renderCalendar();};
      document.getElementById('nextMonth').onclick=function(){state.monthOffset++; renderCalendar();};
      document.getElementById('icsExport').onclick=exportICS;
      document.getElementById('icsImportFile').addEventListener('change', importICS);
      document.getElementById('gcalSync').onclick=googleImportDemo;
    }

    // ICS
    function exportICS(){ var lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//FamilyHub//HU//']; state.events.forEach(function(e){ lines.push('BEGIN:VEVENT'); lines.push('UID:'+e.id+'@familyhub'); var dt=function(d){ return new Date(d).toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z'); }; lines.push('DTSTART:'+dt(e.start)); if(e.end) lines.push('DTEND:'+dt(e.end)); lines.push('SUMMARY:'+(e.title||'')); if(e.note) lines.push('DESCRIPTION:'+(e.note)); lines.push('END:VEVENT'); }); lines.push('END:VCALENDAR'); var blob=new Blob([lines.join('\n')],{type:'text/calendar'}); el('a',{href:URL.createObjectURL(blob),download:'familyhub.ics'}).click(); }
    function importICS(ev){ var f=ev.target.files[0]; if(!f) return; f.text().then(function(text){ var items=[]; var cur=null; text.split(/\r?\n/).forEach(function(line){ if(line==='BEGIN:VEVENT'){ cur={}; } else if(line==='END:VEVENT'){ if(cur&&cur.title&&cur.start) items.push(cur); cur=null; } else if(cur){ if(line.indexOf('SUMMARY:')===0) cur.title=line.slice(8); else if(line.indexOf('DTSTART:')===0) cur.start=icsToDate(line.slice(8)); else if(line.indexOf('DTEND:')===0) cur.end=icsToDate(line.slice(6)); else if(line.indexOf('DESCRIPTION:')===0) cur.note=line.slice(12); } }); items.forEach(function(e){ state.events.push({id:genId('e'), title:e.title, start:e.start, end:e.end, note:e.note}); }); save(); renderCalendar(); notifyLocal('ICS import kész', items.length+' esemény hozzáadva'); ev.target.value=''; });
      function icsToDate(s){ var m=/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z$/.exec(s); return m? new Date(Date.UTC(+m[1],+m[2]-1,+m[3],+m[4],+m[5],+m[6])):new Date(s); }
    }

    // tasks
    function renderTasks(){ var root=$('#view-tasks'); if(!root) return; root.innerHTML=$('#tpl-tasks').innerHTML; var sel=document.getElementById('taskAssignee'); sel.innerHTML=''; state.family.members.forEach(function(m){ sel.append(el('option',{value:m.id},[m.name])); }); function draw(){ var f=document.getElementById('taskFilter').value; var wrap=document.getElementById('taskList'); wrap.innerHTML=''; state.tasks.filter(function(t){ return f==='all'||(f==='open'&&!t.done)||(f==='done'&&t.done); }).forEach(function(t){ var it=el('div',{class:'item'}); var chk=el('input',{type:'checkbox'}); chk.checked=t.done; chk.onchange=function(){ t.done=chk.checked; save(); draw(); }; var meta=el('div',{},[el('div',{html:'<strong>'+t.title+'</strong> '+memberPill(t.assignee)}), el('div',{class:'muted',html:new Date(t.created).toLocaleString()})]); var del=el('button',{onclick:function(){ state.tasks=state.tasks.filter(function(x){return x.id!==t.id;}); save(); draw(); }},['Törlés']); it.append(chk,meta,del); wrap.append(it); }); } draw(); document.getElementById('taskAdd').onclick=function(){ var title=document.getElementById('taskTitle').value.trim(); if(!title) return; var a=document.getElementById('taskAssignee').value; state.tasks.unshift({id:genId('t'), title:title, assignee:a, done:false, created:Date.now()}); save(); draw(); notifyLocal('Új teendő', title); document.getElementById('taskTitle').value=''; }; document.getElementById('taskFilter').onchange=draw; document.getElementById('clearDone').onclick=function(){ state.tasks=state.tasks.filter(function(t){return !t.done;}); save(); draw(); } }

    // shopping
    function renderShopping(){ var root=$('#view-shopping'); if(!root) return; root.innerHTML=$('#tpl-shopping').innerHTML; function draw(){ var wrap=document.getElementById('shopList'); wrap.innerHTML=''; state.shopping.forEach(function(itm){ var it=el('div',{class:'item'}); var chk=el('input',{type:'checkbox'}); chk.checked=!!itm.bought; chk.onchange=function(){ itm.bought=chk.checked; save(); draw(); }; var meta=el('div',{},[ el('div',{html:'<strong>'+itm.title+'</strong> <span class="muted">'+(itm.qty||'')+' '+(itm.cat? '• '+itm.cat:'')+'</span>'}), el('div',{class:'muted', html:memberPill(itm.by)+' • '+new Date(itm.created).toLocaleString()}) ]); var del=el('button',{onclick:function(){ state.shopping=state.shopping.filter(function(x){return x.id!==itm.id;}); save(); draw(); }},['Törlés']); it.append(chk,meta,del); wrap.append(it); }); } draw(); document.getElementById('shopAdd').onclick=function(){ var title=document.getElementById('shopTitle').value.trim(); if(!title) return; var qty=document.getElementById('shopQty').value.trim(); var cat=document.getElementById('shopCat').value; var by=state.family.members[0]? state.family.members[0].id : null; state.shopping.unshift({id:genId('s'), title:title, qty:qty, cat:cat, by:by, created:Date.now()}); save(); draw(); notifyLocal('Bevásárlólista', title+(qty?' × '+qty:'')); document.getElementById('shopTitle').value=''; document.getElementById('shopQty').value=''; }; document.getElementById('shopClearBought').onclick=function(){ state.shopping=state.shopping.filter(function(i){return !i.bought;}); save(); draw(); } }

    // wall
    function renderWall(){ var root=$('#view-wall'); if(!root) return; root.innerHTML=$('#tpl-wall').innerHTML; function draw(){ var wrap=document.getElementById('wallFeed'); wrap.innerHTML=''; state.wall.slice(0,100).forEach(function(w){ var it=el('div',{class:'item'}); var found=state.family.members.find(function(m){return m.id===w.by;})||{}; var color=found.color||'#333'; var name=found.name||'Ismeretlen'; it.append( el('div',{class:'avatar',style:'background:'+color}), el('div',{},[ el('div',{html:'<strong>'+name+'</strong> <span class="muted">'+new Date(w.at).toLocaleString()+'</span>'}), el('div',{html:w.text}) ]) ); wrap.append(it); }); } draw(); document.getElementById('wallSend').onclick=function(){ var text=document.getElementById('wallMsg').value.trim(); if(!text) return; var by=state.family.members[0]? state.family.members[0].id : null; state.wall.unshift({id:genId('w'), text:text, by:by, at:Date.now()}); save(); draw(); notifyLocal('Új üzenet', text); document.getElementById('wallMsg').value=''; } }

    // settings
    function renderSettings(){ var root=$('#view-settings'); if(!root) return; root.innerHTML=$('#tpl-settings').innerHTML; document.getElementById('familyName').value=state.family.name||''; document.getElementById('familyName').oninput=function(e){ state.family.name=e.target.value; document.getElementById('familyNameLabel').textContent=state.family.name||'Család'; save(); }; var list=document.getElementById('members'); list.innerHTML=''; state.family.members.forEach(function(m){ var row=el('div',{class:'item'},[ el('span',{class:'avatar',style:'background:'+m.color}), el('div',{},[el('div',{html:'<strong>'+m.name+'</strong> <span class="muted">'+(m.emoji||'')+'</span>'})]), el('button',{onclick:function(){ state.tasks.forEach(function(t){ if(t.assignee===m.id) t.assignee=state.family.members[0]? state.family.members[0].id : null; }); state.family.members=state.family.members.filter(function(x){return x.id!==m.id;}); save(); renderSettings(); }},['Eltávolítás']) ]); list.append(row); }); document.getElementById('addMember').onclick=function(){ var name=document.getElementById('memberName').value.trim(); if(!name) return; var emoji=document.getElementById('memberEmoji').value.trim(); var color=document.getElementById('memberColor').value; state.family.members.push({id:genId('m'), name:name, emoji:emoji, color:color}); save(); renderSettings(); document.getElementById('memberName').value=''; document.getElementById('memberEmoji').value=''; };
      document.getElementById('btnGoogleSignIn').onclick=function(){ toast('Demo: itt jelenne meg a Google bejelentkezés (OAuth)'); };
      document.getElementById('btnGoogleImport').onclick=googleImportDemo;
      document.getElementById('btnTestNotify').onclick=function(){ notifyLocal('FamilyHub','Ez egy teszt értesítés.'); };
      document.getElementById('btnPushEnable').onclick=function(){ ensureNotifications().then(function(ok){ if(ok) pushEnable(); }); };
      document.getElementById('btnPushDisable').onclick=pushDisable;
      document.getElementById('btnPushTest').onclick=pushTest;
      document.getElementById('btnTestSW').onclick=testSW;
      document.getElementById('btnSelfTestICS').onclick=selfTestICS;
      document.getElementById('btnOpenOfflineTest').onclick=function(){ var isBlob=location.protocol==='blob:'; var isFile=location.protocol==='file:'; var isOpaque=location.origin==='null'; var BASE=(isBlob||isFile||isOpaque)? '/' : (location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/[^/]+$/, '')); var path='/offline-test-'+Math.random().toString(36).slice(2,6); window.open(BASE+path.replace(/^\//,''), '_blank'); };
      document.getElementById('btnUnregSW').onclick=unregisterAllSW;
      document.getElementById('btnClearCaches').onclick=clearAllCaches;
      document.getElementById('btnFactoryReset').onclick=function(){ unregisterAllSW().then(function(){ return clearAllCaches(); }).then(function(){ localStorage.removeItem('familyhub.data'); toast('Gyári visszaállítás kész. Frissítés…'); setTimeout(function(){ location.reload(); },600); }); };
    }

    // Web Push kliens (beta; szerver nélkül csendben hibát jelez toastban)
    var SERVER_BASE='https://YOUR-PUSH-SERVER.example.com';
    function urlBase64ToUint8Array(base64){ var pad='='.repeat((4-base64.length%4)%4); var b64=(base64+pad).replace(/-/g,'+').replace(/_/g,'/'); var raw=atob(b64); var out=new Uint8Array(raw.length); for(var i=0;i<raw.length;i++) out[i]=raw.charCodeAt(i); return out; }
    function getVapidKey(){ return fetch(SERVER_BASE+'/vapid/public').then(function(r){ if(!r.ok) throw new Error('VAPID kulcs hiba'); return r.json(); }).then(function(j){ return urlBase64ToUint8Array(j.publicKey); }); }
    function pushEnable(){ if(!('serviceWorker' in navigator) || !('PushManager' in window)) return toast('Push nem támogatott'); navigator.serviceWorker.ready.then(function(reg){ return getVapidKey().then(function(key){ return reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey:key }); }).then(function(sub){ return fetch(SERVER_BASE+'/subscribe',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(sub) }); }).then(function(){ toast('Push feliratkozás kész'); }).catch(function(e){ console.error(e); toast('Push engedélyezés hiba'); }); }); }
    function pushDisable(){ navigator.serviceWorker.ready.then(function(reg){ return reg.pushManager.getSubscription(); }).then(function(sub){ if(!sub) return; return fetch(SERVER_BASE+'/unsubscribe',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(sub) }).catch(function(){}).then(function(){ return sub.unsubscribe(); }).then(function(){ toast('Push leiratkozva'); }); }).catch(function(e){ console.error(e); toast('Leiratkozás hiba'); }); }
    function pushTest(){ fetch(SERVER_BASE+'/notify',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title:'FamilyHub', body:'Szerver küldte ezt a teszt push-t.' }) }).then(function(){ toast('Teszt push elküldve'); }).catch(function(e){ console.error(e); toast('Teszt push hiba'); }); }

    // demos & export
    function googleImportDemo(){ toast('Demo: Google Calendar import helykitöltő. ICS export/import működik.'); }
    function exportAll(){ var blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); el('a',{href:URL.createObjectURL(blob), download:'FamilyHub_backup_'+new Date().toISOString().slice(0,10)+'.json'}).click(); }

    // PWA register (vászonbarát)
    function registerPWA(){ var isBlob=location.protocol==='blob:'; var isFile=location.protocol==='file:'; var isOpaque=location.origin==='null'; var isSandbox=isBlob||isFile||isOpaque; var BASE=isSandbox? '/' : (location.pathname.endsWith('/')? location.pathname : location.pathname.replace(/[^/]+$/, ''));
      // Manifest
      var manifest={ name:'FamilyHub • Napi Kör', short_name:'FamilyHub', start_url:BASE, scope:BASE, display:'standalone', background_color:'#0b1020', theme_color:'#0b1020', icons:[192,512].map(function(sz){return {src:svgIconDataURI(), sizes:sz+'x'+sz, type:'image/png', purpose:'any maskable'};}) };
      var mURL=URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'})); var link=document.createElement('link'); link.rel='manifest'; link.href=mURL; document.head.appendChild(link);
      if(isSandbox){ console.warn('Sandbox/vászon: SW tiltva.'); toast('Vászon módban az SW kikapcsolva — ez normális.'); return; }
      if('serviceWorker' in navigator){ var swURL=new URL('sw.js', location.origin+BASE).toString(); navigator.serviceWorker.register(swURL,{scope:BASE}).then(function(reg){ console.info('SW reg OK:',reg.scope); }).catch(function(err){ console.error('SW reg error',err); toast('SW reg hiba: hiányzik a sw.js a '+BASE+' alatt?'); }); window.__FHUB_DOWNLOAD_SW__=function(){ var code=makeSWCodeFromScope(BASE); var blob=new Blob([code],{type:'application/javascript'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sw.js'; a.click(); }; }
    }
    function svgIconDataURI(){ var svg="<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><defs><linearGradient id='g' x1='0' x2='0' y1='0' y2='1'><stop offset='0%' stop-color='%234cc9f0'/><stop offset='100%' stop-color='%23b5179e'/></linearGradient></defs><rect rx='30' width='128' height='128' fill='url(%23g)'/><circle cx='43' cy='54' r='10' fill='white'/><circle cx='85' cy='54' r='10' fill='white'/><path d='M30 80c10-18 58-18 68 0-6 22-62 22-68 0z' fill='white'/></svg>"; return 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svg); }
    function makeSWCodeFromScope(BASE){ var offlineHTML='<!doctype html><html lang="hu"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Offline • FamilyHub</title><style>body{margin:0;font-family:system-ui,Segoe UI,Roboto;background:#0b1020;color:#e6eefb;display:grid;place-items:center;height:100vh}.box{max-width:560px;padding:24px;border:1px solid #27406b;border-radius:16px;background:#0f1730;box-shadow:0 10px 40px rgba(0,0,0,.35)}h1{margin:0 0 8px}p{color:#9fb2d6}button{padding:10px 14px;border-radius:12px;border:1px solid #2a3a62;background:#152039;color:#fff;cursor:pointer}button:active{transform:translateY(1px)}</style></head><body><div class="box"><h1>Offline mód</h1><p>Úgy tűnik, nincs hálózati kapcsolat és ez az oldal még nincs a gyorsítótárban.</p><p>Próbáld meg újra, vagy térj vissza a kezdőlapra.</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="location.reload()">Próbáld újra</button><button onclick="location.href=\''+BASE+'\'">Kezdőlap</button></div></div></body></html>'; return "\nconst CACHE='familyhub-v5';\nconst SCOPE_URL=new URL(self.registration.scope); let BASE=SCOPE_URL.pathname; if(!BASE.endsWith('/')) BASE+='/';\nself.addEventListener('install',e=>{ self.skipWaiting(); e.waitUntil(caches.open(CACHE).then(c=>c.addAll([BASE, BASE+'index.html']).catch(()=>{}))); });\nself.addEventListener('activate',e=>{ self.clients.claim(); e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))); });\nself.addEventListener('fetch',e=>{ const req=e.request; if(req.mode==='navigate'){ e.respondWith((async()=>{ try{ const net=await fetch(req); if(!net.ok) throw new Error('HTTP '+net.status); const copy=net.clone(); caches.open(CACHE).then(c=>c.put(req,copy)); return net; }catch(err){ const cached=await caches.match(req)||await caches.match(BASE)||await caches.match(BASE+'index.html'); if(cached) return cached; return new Response(`+JSON.stringify(offlineHTML)+`,{headers:{'Content-Type':'text/html; charset=utf-8'}}); } })()); return; } e.respondWith((async()=>{ const cached=await caches.match(req); if(cached) return cached; try{ const net=await fetch(req); if(!net.ok) throw new Error('HTTP '+net.status); const copy=net.clone(); caches.open(CACHE).then(c=>c.put(req,copy)); return net; }catch(err){ throw err; } })()); });\nself.addEventListener('push', e=>{ let data={}; try{ data=e.data? e.data.json():{}; }catch{} const title=data.title||'FamilyHub'; const body=data.body||''; const url=data.url||null; const opts={ body, data:{ url }, requireInteraction:false }; e.waitUntil(self.registration.showNotification(title, opts)); });\nself.addEventListener('notificationclick', e=>{ e.notification.close(); const target=e.notification.data&&e.notification.data.url; e.waitUntil((async()=>{ const all=await clients.matchAll({ type:'window', includeUncontrolled:true }); for(const c of all){ if(c.url.includes(BASE)){ c.focus(); if(target) c.navigate(target); return; } } if(target) return clients.openWindow(target); return clients.openWindow(BASE); })()); });\nself.addEventListener('message', e=>{ if(e.data&&e.data.type==='notify'&&self.registration.showNotification){ self.registration.showNotification(e.data.title||'FamilyHub',{ body:e.data.body||'' }); }});\n"; }

    // diagnostics
    function testSW(){ if(!('serviceWorker' in navigator)) { toast('Nincs SW támogatás.'); return; } var isBlob=location.protocol==='blob:'; var isFile=location.protocol==='file:'; var isOpaque=location.origin==='null'; if(isBlob||isFile||isOpaque){ toast('Vászon/Blob/File módban az SW le van tiltva — ez várható.'); return; } navigator.serviceWorker.getRegistrations().then(function(regs){ if(!regs.length){ toast('Nem található SW regisztráció. (Valós originen fut? sw.js a helyén?)'); return; } var scopes=regs.map(function(r){return r.scope;}).join(', '); toast('SW aktív scope-ok: '+scopes); }).catch(function(e){ console.error(e); toast('SW teszt hiba'); }); }
    function unregisterAllSW(){ if(!('serviceWorker' in navigator)) { toast('Nincs SW támogatás.'); return Promise.resolve(); } return navigator.serviceWorker.getRegistrations().then(function(regs){ return Promise.all(regs.map(function(r){return r.unregister();})); }).then(function(){ toast('SW(ek) eltávolítva.'); }); }
    function clearAllCaches(){ return caches.keys().then(function(keys){ return Promise.all(keys.map(function(k){return caches.delete(k);})); }).then(function(){ toast('Cache(ek) ürítve.'); }).catch(function(e){ console.error(e); toast('Cache ürítés hiba'); }); }
    function selfTestICS(){ var tmp={ id:genId('e'), title:'[TESZT] ICS', start:new Date(), end:new Date(Date.now()+3600000), note:'diagnosztika' }; var backup=state.events.slice(); state.events.push(tmp); var lines=['BEGIN:VEVENT','UID:'+tmp.id+'@familyhub','DTSTART:'+new Date(tmp.start).toISOString(),'DTEND:'+new Date(tmp.end).toISOString(),'SUMMARY:'+tmp.title,'DESCRIPTION:'+tmp.note,'END:VEVENT']; var ok=lines.join('\n').indexOf('DTSTART:')>0; state.events=backup; toast(ok?'ICS ön-teszt: OK':'ICS ön-teszt: HIBA'); }

    // Smoke tesztek (futáskor)
    function smoke(){ try{ switchView('dashboard'); switchView('calendar'); var g=document.getElementById('calGrid'); if(!g) throw new Error('calGrid hiányzik'); switchView('tasks'); switchView('shopping'); switchView('wall'); switchView('settings'); console.log('[Smoke] OK'); }catch(e){ console.error('[Smoke] hiba', e); if(window.__FHUB_DEBUG_OVERLAY__) window.__FHUB_DEBUG_OVERLAY__(e.stack||e.message); }}

    // header & init
    var deferredPrompt=null; addEventListener('beforeinstallprompt', function(e){ e.preventDefault(); deferredPrompt=e; var b=document.getElementById('installBtn'); if(b) b.disabled=false; });
    function bindHeader(){ var b=document.getElementById('installBtn'); if(b) b.onclick=function(){ if(!deferredPrompt){ toast('Már telepítve lehet vagy még nem elérhető.'); return; } deferredPrompt.prompt(); }; var nb=document.getElementById('notifBtn'); if(nb) nb.addEventListener('click', ensureNotifications); var ex=document.getElementById('exportBtn'); if(ex) ex.addEventListener('click', exportAll); document.getElementById('familyNameLabel').textContent=state.family.name||'Család'; updateNet(); }
    function init(){ load(); bindHeader(); renderTabs('dashboard'); switchView('dashboard'); registerPWA(); smoke(); }

    return { init: init };
  })();

  // Boot
  document.addEventListener('DOMContentLoaded', function(){ try{ App.init(); }catch(e){ console.error(e); window.__FHUB_DEBUG_OVERLAY__ && window.__FHUB_DEBUG_OVERLAY__(e.stack||e.message); } });
  </script>
</body>
</html>
