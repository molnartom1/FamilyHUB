<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>FamilyBoard v11d-final</title>
  <link rel="manifest" href="./manifest.webmanifest?v=11d-final" />
  <style>
    :root {
      /* Vil√°gos m√≥d sz√≠nei */
      --primary: #0ea5e9;
      --bg: #f6f8fb;
      --card: #fff;
      --text: #222;
      --muted: #6b7280;
      --border: #e5e7eb;
    }

    [data-theme="dark"] {
      /* S√∂t√©t m√≥d sz√≠nei */
      --primary: #9cf;
      --bg: #121212;
      --card: #1e1e1e;
      --text: #eee;
      --muted: #aaa;
      --border: #333;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }

    header {
      background: var(--primary);
      color: #fff;
      text-align: center;
      padding: 14px;
      font-weight: 700;
      font-size: 18px;
      user-select: none;
    }

    .center {
      max-width: 520px;
      margin: 24px auto;
      padding: 0 10px;
    }

    .card {
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .muted {
      color: var(--muted);
    }

    input[type="text"],
    input[type="time"],
    select {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 16px;
    }

    input[type="text"] {
      flex: 1;
    }

    input[type="time"],
    select {
      width: 120px;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 16px;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
    }

    button:hover {
      background: #0b78c5;
    }

    button.ghost {
      background: #fff;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    ul {
      list-style: none;
      padding: 0;
      margin-top: 12px;
    }

    li {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    li button.delete-btn {
      background: transparent;
      color: var(--muted);
      font-weight: bold;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 0 8px;
      user-select: none;
    }

    #darkModeToggle {
      position: fixed;
      top: 8px;
      right: 8px;
      z-index: 1000;
      font-size: 14px;
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
    }

    #darkModeToggle:hover {
      background: #0b78c5;
    }

    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-gap: 6px;
      background: var(--card);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 20px;
      user-select: none;
    }

    #calendar .day,
    #calendar .day-header {
      padding: 8px;
      text-align: center;
      border-radius: 6px;
      position: relative;
    }

    #calendar .day-header {
      font-weight: bold;
      color: var(--primary);
    }

    #calendar .day {
      cursor: pointer;
      background: var(--bg);
      border: 1px solid var(--border);
      min-height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      transition: background 0.3s;
      flex-direction: column;
    }

    #calendar .day:hover {
      background: var(--primary);
      color: #fff;
    }

    #calendar .selected {
      background: var(--primary);
      color: #fff;
      font-weight: bold;
    }

    #calendar .dot {
      width: 6px;
      height: 6px;
      background-color: var(--primary);
      border-radius: 50%;
      margin-top: 3px;
    }
  </style>
</head>

<body>
  <header>Family Board</header>

  <button id="darkModeToggle" aria-label="S√∂t√©t m√≥d kapcsol√≥">
    Dark Mode
  </button>

  <div id="app" class="center">

    <!-- Teljes m√©ret≈± havi napt√°r -->
    <div id="calendar"></div>

    <!-- Teend≈ëk -->
    <div class="card" aria-label="Teend≈ë lista">
      <h2>üìã Teend≈ëk</h2>
      <div class="row">
        <input type="text" id="taskInput" placeholder="√öj teend≈ë‚Ä¶" aria-label="√öj teend≈ë" />
        <input type="time" id="taskTime" aria-label="Id≈ë (HH:MM)" />
        <button id="addTask" title="Hozz√°ad√°s">+</button>
      </div>
      <ul id="taskList"></ul>
    </div>

    <!-- Bev√°s√°rl√≥lista -->
    <div class="card" aria-label="Bev√°s√°rl√≥lista">
      <h2>üõí Bev√°s√°rl√≥lista</h2>
      <div class="row">
        <input type="text" id="shoppingInput" placeholder="√öj t√©tel‚Ä¶" aria-label="√öj t√©tel" />
        <button id="addShopping" title="Hozz√°ad√°s">+</button>
      </div>
      <ul id="shoppingList"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInAnonymously,
      setPersistence,
      browserLocalPersistence,
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import {
      getFirestore,
      enableIndexedDbPersistence,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      deleteDoc,
      doc,
      getDocs,
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAeoxtOe5Cleasm3KdeSHP9WDR3PkU-N1I",
      authDomain: "mosas-nyilvantartas.firebaseapp.com",
      projectId: "mosas-nyilvantartas",
      storageBucket: "mosas-nyilvantartas.firebasestorage.app",
      messagingSenderId: "38259241645",
      appId: "1:38259241645:web:26070b1d0686def9f00c24"
    };
    initializeApp(firebaseConfig);
    const auth = getAuth();
    setPersistence(auth, browserLocalPersistence);
    const db = getFirestore();
    enableIndexedDbPersistence(db).catch(() => {});

    const householdId = "default";

    // --- Dark mode toggle ---
    const toggleBtn = document.getElementById('darkModeToggle');
    const rootElem = document.documentElement;

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      rootElem.setAttribute('data-theme', savedTheme);
    }
    toggleBtn.addEventListener('click', () => {
      const currentTheme = rootElem.getAttribute('data-theme');
      if (currentTheme === 'dark') {
        rootElem.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
      } else {
        rootElem.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
      }
    });

    // --- Notification permission ---
    async function requestNotificationPermission() {
      if (!("Notification" in window)) {
        alert("Ez a b√∂ng√©sz≈ë nem t√°mogatja az √©rtes√≠t√©seket.");
        return false;
      }
      if (Notification.permission === "granted") return true;
      if (Notification.permission !== "denied") {
        const permission = await Notification.requestPermission();
        return permission === "granted";
      }
      return false;
    }

    // --- Local notification ---
    function showLocalNotification(title, body) {
      if (Notification.permission !== "granted") return;
      new Notification(title, {
        body,
        icon: "icons/icon-192.png",
      });
    }

    // --- Date form√°z√°s ---
    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    // --- Havi t√©telnapok bet√∂lt√©se a p√∂tty√∂kh√∂z ---
    let monthItems = new Set();

    async function loadMonthItems(year, month) {
      monthItems.clear();
      const tasksRef = collection(db, `households/${householdId}/tasks`);
      const shoppingRef = collection(db, `households/${householdId}/shopping`);
      const monthStr = `${year}-${String(month + 1).padStart(2, "0")}`;

      await Promise.all([
        getDocs(tasksRef).then((snapshot) => {
          snapshot.forEach((doc) => {
            const data = doc.data();
            if (data.date && data.date.startsWith(monthStr)) {
              monthItems.add(data.date);
            }
          });
        }),
        getDocs(shoppingRef).then((snapshot) => {
          snapshot.forEach((doc) => {
            const data = doc.data();
            if (data.date && data.date.startsWith(monthStr)) {
              monthItems.add(data.date);
            }
          });
        }),
      ]);
    }

    // --- Napt√°r gener√°l√°sa ---
    let selectedDate = new Date();
    const calendarElem = document.getElementById('calendar');

    async function createCalendar(year, month) {
      await loadMonthItems(year, month);

      calendarElem.innerHTML = '';
      const daysOfWeek = ['H', 'K', 'Sze', 'Cs', 'P', 'Szo', 'V'];
      daysOfWeek.forEach(day => {
        const header = document.createElement('div');
        header.textContent = day;
        header.classList.add('day-header');
        calendarElem.appendChild(header);
      });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      const daysInMonth = lastDay.getDate();

      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.classList.add('day');
        calendarElem.appendChild(emptyCell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.classList.add('day');
        dayCell.textContent = day;

        // D√°tum sztring a h√≥naphoz
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        if (monthItems.has(dateStr)) {
          const dot = document.createElement('span');
          dot.className = 'dot';
          dayCell.appendChild(dot);
        }

        if (year === selectedDate.getFullYear() && month === selectedDate.getMonth() && day === selectedDate.getDate()) {
          dayCell.classList.add('selected');
        }

        dayCell.addEventListener('click', () => {
          selectedDate = new Date(year, month, day);
          createCalendar(year, month);
          loadTasks();
          loadShopping();
        });

        calendarElem.appendChild(dayCell);
      }
    }

    // --- Teend≈ëk ---
    const taskInput = document.getElementById('taskInput');
    const taskTime = document.getElementById('taskTime');
    const addTask = document.getElementById('addTask');
    const taskList = document.getElementById('taskList');

    let unsubscribeTasks = null;
    function loadTasks() {
      if (unsubscribeTasks) unsubscribeTasks();
      const tasksRef = collection(db, `households/${householdId}/tasks`);
      const q = query(tasksRef, orderBy('createdAt', 'desc'));
      unsubscribeTasks = onSnapshot(q, (snapshot) => {
        const dateStr = formatDate(selectedDate);
        const tasks = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.date === dateStr) {
            tasks.push({ ...data, docId: doc.id });
          }
        });
        renderTasks(tasks);
      });
    }
    function renderTasks(tasks) {
      taskList.innerHTML = '';
      tasks.forEach(task => {
        const li = document.createElement('li');
        li.textContent = (task.time ? `[${task.time}] ` : '') + task.text;
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.title = 'T√∂rl√©s';
        delBtn.textContent = '‚úñ';
        delBtn.addEventListener('click', async () => {
          const pin = prompt('Add meg a PIN k√≥dot a t√∂rl√©shez:');
          if (pin !== '2025') {
            alert('Hib√°s PIN k√≥d!');
            return;
          }
          await deleteDoc(doc(db, `households/${householdId}/tasks`, task.docId));
        });
        li.appendChild(delBtn);
        taskList.appendChild(li);
      });
    }
    addTask.addEventListener('click', async () => {
      const text = taskInput.value.trim();
      const time = taskTime.value.trim();
      if (!text) return alert('Adj meg egy teend≈ët!');
      const dateStr = formatDate(selectedDate);
      await addDoc(collection(db, `households/${householdId}/tasks`), {
        text,
        time: time || '',
        date: dateStr,
        createdAt: Date.now()
      });
      showLocalNotification('√öj teend≈ë', `Feladat: ${text}`);
      taskInput.value = '';
      taskTime.value = '';
    });

    // --- Bev√°s√°rl√≥lista ---
    const shoppingInput = document.getElementById('shoppingInput');
    const addShopping = document.getElementById('addShopping');
    const shoppingList = document.getElementById('shoppingList');

    let unsubscribeShopping = null;
    function loadShopping() {
      if (unsubscribeShopping) unsubscribeShopping();
      const shoppingRef = collection(db, `households/${householdId}/shopping`);
      const q = query(shoppingRef, orderBy('createdAt', 'desc'));
      unsubscribeShopping = onSnapshot(q, (snapshot) => {
        const items = [];
        snapshot.forEach(doc => {
          items.push({ ...doc.data(), docId: doc.id });
        });
        renderShopping(items);
      });
    }
    function renderShopping(items) {
      shoppingList.innerHTML = '';
      items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item.text;
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.title = 'T√∂rl√©s';
        delBtn.textContent = '‚úñ';
        delBtn.addEventListener('click', async () => {
          const pin = prompt('Add meg a PIN k√≥dot a t√∂rl√©shez:');
          if (pin !== '2025') {
            alert('Hib√°s PIN k√≥d!');
            return;
          }
          await deleteDoc(doc(db, `households/${householdId}/shopping`, item.docId));
        });
        li.appendChild(delBtn);
        shoppingList.appendChild(li);
      });
    }
    addShopping.addEventListener('click', async () => {
      const text = shoppingInput.value.trim();
      if (!text) return alert('Adj meg egy bev√°s√°rl√≥ t√©telt!');
      await addDoc(collection(db, `households/${householdId}/shopping`), {
        text,
        createdAt: Date.now()
      });
      showLocalNotification('√öj bev√°s√°rl√≥ t√©tel', `T√©tel: ${text}`);
      shoppingInput.value = '';
    });

    // App inicializ√°l√°sa
    async function init() {
      await signInAnonymously(auth);
      await requestNotificationPermission();
      createCalendar(selectedDate.getFullYear(), selectedDate.getMonth());
      loadTasks();
      loadShopping();
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        init();
      } else {
        signInAnonymously(auth);
      }
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js?v=11d-final');
    }
  </script>

</body>

</html>
