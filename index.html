<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FamilyBoard ‚Äì Fi√≥kokkal (offline)</title>
  <style>
    :root{ --primary:#0ea5e9; --bg:#f6f8fb; --card:#fff; --text:#222; --muted:#6b7280; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;
      background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; min-height:100vh; }
    header{width:100%; background:var(--primary); color:#fff; padding:14px 16px; text-align:center; font-size:20px; font-weight:700}
    main{width:min(1000px,94vw); margin:18px auto; display:grid; gap:16px; grid-template-columns:1fr;}
    @media (min-width:1000px){ main{ grid-template-columns: 1.2fr 1fr; } }
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,.05)}
    h2{margin:0 0 10px; font-size:18px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .right{margin-left:auto}
    button{cursor:pointer; border:none; background:var(--primary); color:#fff; padding:8px 12px; border-radius:10px; font-weight:600}
    button.ghost{background:transparent; color:var(--primary); border:1px solid var(--primary)}
    input[type="text"], input[type="password"], input[type="time"], input[type="number"]{
      padding:10px 12px; border-radius:10px; border:1px solid var(--border); font-size:15px
    }
    input[type="text"], input[type="password"]{flex:1}
    ul{list-style:none; margin:10px 0 0; padding:0}
    li.item{display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border); padding:8px 4px}
    li.item:last-child{border-bottom:none}
    li.item.done span.txt{ text-decoration: line-through; color:#9ca3af }
    .badge-time{ font-size:12px; background:#0ea5e91a; color:#0369a1; border:1px solid #bae6fd; padding:3px 8px; border-radius:999px; }
    .pill{font-size:12px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe}
    /* Calendar */
    .cal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .cal-head h3{margin:0; font-size:16px}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:4px}
    .dow{font-size:12px; text-align:center; color:var(--muted); padding:6px 0}
    .day{ position:relative; background:#fff; border:1px solid var(--border); border-radius:10px;
      padding:10px; text-align:right; min-height:52px; font-weight:600; color:#111; }
    .day.out{color:#bbb; background:#fafafa}
    .day.selected{outline:2px solid var(--primary); box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    .count{position:absolute; left:6px; top:6px; font-size:11px; color:#fff; background:var(--primary); padding:2px 6px; border-radius:999px}
    /* Auth */
    .center{ max-width:520px; width:92vw; margin:28px auto; }
    .hint{font-size:12px; color:#64748b}
    .sep{height:1px; background:var(--border); margin:8px 0}
  </style>
</head>
<body>
  <header>üîê FamilyBoard ‚Äì fi√≥kokkal (offline)</header>

  <!-- First-run admin setup -->
  <div id="setup" class="center card" hidden>
    <h2>Els≈ë l√©p√©s: Admin fi√≥k l√©trehoz√°sa</h2>
    <p class="muted">Ez az eszk√∂z b√∂ng√©sz≈ëj√©ben t√°rolja az adatokat. K√©rlek √°ll√≠ts be egy admin felhaszn√°l√≥t.</p>
    <div class="row" style="margin-top:8px">
      <input id="suName" type="text" placeholder="Admin felhaszn√°l√≥n√©v (pl. anya_admin)" />
      <input id="suPass" type="password" placeholder="Jelsz√≥" />
    </div>
    <div class="row" style="margin-top:8px">
      <button id="createAdmin">Admin l√©trehoz√°sa</button>
    </div>
    <p class="hint">Megjegyz√©s: minden helyben t√°rol√≥dik. M√°sik eszk√∂z√∂n √∫jra l√©tre kell hozni vagy export/import kell majd szinkronhoz.</p>
  </div>

  <!-- Login -->
  <div id="login" class="center card" hidden>
    <h2>Bejelentkez√©s</h2>
    <div class="row" style="margin-top:8px">
      <input id="liName" type="text" placeholder="Felhaszn√°l√≥n√©v" />
      <input id="liPass" type="password" placeholder="Jelsz√≥" />
    </div>
    <div class="row" style="margin-top:8px">
      <button id="doLogin">Bel√©p√©s</button>
    </div>
    <p class="hint">Elfelejtett jelsz√≥? K√©rd az adminot, hogy √°ll√≠tson be √∫jat.</p>
  </div>

  <!-- App -->
  <div id="app" hidden>
    <div class="center card" style="margin-bottom:0">
      <div class="row">
        <div>Bejelentkezve: <strong id="who"></strong> <span id="roleBadge" class="pill"></span></div>
        <button id="changePass" class="ghost right">Jelsz√≥ m√≥dos√≠t√°sa</button>
        <button id="logout" class="ghost">Kijelentkez√©s</button>
      </div>
    </div>

    <main>
      <!-- BAL oszlop: napt√°r + napi teend≈ëk -->
      <section>
        <div class="card">
          <div class="cal-head">
            <button id="prev" class="ghost">‚óÄ</button>
            <h3 id="monthLabel">2025. okt√≥ber</h3>
            <button id="next" class="ghost">‚ñ∂</button>
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>Teend≈ëk ‚Äì <span id="dateOut" class="muted">-</span></h2>
          <div class="row" style="margin-bottom:8px; flex-wrap:wrap">
            <input type="text" id="taskInput" placeholder="√öj teend≈ë..." />
            <input type="time" id="taskTime" aria-label="Id≈ëpont (√≥ra:perc)" />
            <button id="addTask">Hozz√°ad√°s</button>
          </div>
          <ul id="taskList"></ul>
          <div class="row" style="margin-top:8px">
            <span class="muted">Id≈ë szerinti rendez√©s ‚Ä¢ √ºres id≈ë = lista v√©ge</span>
            <button id="clearDone" class="ghost right">K√©sz teend≈ëk t√∂rl√©se</button>
          </div>
        </div>
      </section>

      <!-- JOBB oszlop: bev√°s√°rl√≥lista + user admin -->
      <section>
        <div class="card">
          <h2>üõí Bev√°s√°rl√≥lista</h2>
          <div class="row" style="margin-bottom:8px">
            <input type="text" id="shopInput" placeholder="√öj t√©tel..." />
            <button id="addItem">Hozz√°ad√°s</button>
          </div>
          <ul id="shopList"></ul>
          <p class="muted">T√∂rl√©shez PIN sz√ºks√©ges (2025).</p>
        </div>

        <div id="userAdmin" class="card" hidden>
          <h2>üë§ Felhaszn√°l√≥k (admin)</h2>
          <div class="row" style="margin-bottom:8px">
            <input id="newUser" type="text" placeholder="√öj felhaszn√°l√≥n√©v" />
            <input id="newPass" type="password" placeholder="Ideiglenes jelsz√≥" />
            <select id="newRole">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
            <button id="addUser">Hozz√°ad√°s</button>
          </div>
          <div class="sep"></div>
          <ul id="userList"></ul>
          <p class="muted">Jelsz√≥-vissza√°ll√≠t√°s √©s t√∂rl√©s PIN-nel (2025). Az utols√≥ admin nem t√∂r√∂lhet≈ë.</p>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ====== √Åltal√°nos seg√©dek ======
    const $ = s => document.querySelector(s);
    const pad = n => String(n).padStart(2,"0");
    const ymdOf = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const today = () => ymdOf(new Date());
    const DOW = ['H','K','Sze','Cs','P','Szo','V'];
    const PIN = "2025";
    const requirePin = (msg="PIN sz√ºks√©ges a m≈±velethez") => prompt(msg) === PIN;

    function uid(){ return crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) }
    function load(k,f){ try{return JSON.parse(localStorage.getItem(k)) ?? f}catch{return f} }
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

    // SHA-256 hash (Web Crypto)
    async function sha256(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // ====== Auth & Users (local) ======
    // users: [{id, username, passHash, role:'admin'|'user'}]
    let users = load('fb_users_v1', []);
    let session = load('fb_session', null); // {id, username, role}

    const setup = $('#setup'), login = $('#login'), app = $('#app');

    function show(view){
      setup.hidden = view!=="setup";
      login.hidden = view!=="login";
      app.hidden = view!=="app";
    }

    async function bootAuth(){
      if (!users.length){
        show('setup'); return;
      }
      if (!session){
        show('login'); return;
      }
      // be√°ll√≠t UI
      $('#who').textContent = session.username;
      const roleBadge = $('#roleBadge');
      roleBadge.textContent = session.role;
      roleBadge.style.display = 'inline-block';
      $('#userAdmin').hidden = session.role !== 'admin';
      show('app');
      // app init
      initApp();
    }

    // First-run admin creation
    $('#createAdmin').onclick = async ()=>{
      const name = $('#suName').value.trim();
      const pass = $('#suPass').value;
      if (!name || !pass) { alert('Adj meg felhaszn√°l√≥nevet √©s jelsz√≥t.'); return; }
      const passHash = await sha256(pass);
      const u = { id: uid(), username: name, passHash, role:'admin' };
      users = [u];
      save('fb_users_v1', users);
      session = { id: u.id, username: u.username, role: u.role };
      save('fb_session', session);
      show('app');
      $('#who').textContent = session.username;
      $('#roleBadge').textContent = session.role;
      $('#userAdmin').hidden = false;
      initApp();
    };

    // Login
    $('#doLogin').onclick = async ()=>{
      const name = $('#liName').value.trim();
      const pass = $('#liPass').value;
      const user = users.find(u=>u.username===name);
      if (!user) { alert('Nincs ilyen felhaszn√°l√≥.'); return; }
      const hash = await sha256(pass);
      if (hash !== user.passHash){ alert('Hib√°s jelsz√≥.'); return; }
      session = { id:user.id, username:user.username, role:user.role };
      save('fb_session', session);
      show('app');
      $('#who').textContent = session.username;
      $('#roleBadge').textContent = session.role;
      $('#userAdmin').hidden = session.role!=='admin';
      initApp();
    };

    // Logout
    $('#logout').onclick = ()=>{
      session = null; save('fb_session', null);
      show('login');
    };

    // Change own password
    $('#changePass').onclick = async ()=>{
      const oldp = prompt('R√©gi jelsz√≥:');
      if (oldp===null) return;
      const user = users.find(u=>u.id===session.id);
      if (!user) return;
      const oldh = await sha256(oldp);
      if (oldh !== user.passHash){ alert('Hib√°s r√©gi jelsz√≥.'); return; }
      const newp = prompt('√öj jelsz√≥:');
      if (newp===null || !newp.length){ alert('√ârv√©nytelen jelsz√≥.'); return; }
      user.passHash = await sha256(newp);
      save('fb_users_v1', users);
      alert('Jelsz√≥ m√≥dos√≠tva.');
    };

    // Admin panel
    $('#addUser').onclick = async ()=>{
      if (session?.role!=='admin') return;
      const name = $('#newUser').value.trim();
      const pass = $('#newPass').value;
      const role = $('#newRole').value;
      if (!name || !pass) { alert('Felhaszn√°l√≥n√©v √©s jelsz√≥ kell.'); return; }
      if (users.some(u=>u.username===name)) { alert('M√°r l√©tezik ilyen felhaszn√°l√≥.'); return; }
      const passHash = await sha256(pass);
      const u = { id: uid(), username: name, passHash, role };
      users.push(u);
      save('fb_users_v1', users);
      $('#newUser').value=''; $('#newPass').value='';
      renderUserList();
    };

    function renderUserList(){
      const ul = $('#userList'); ul.innerHTML='';
      const admins = users.filter(u=>u.role==='admin').length;
      for(const u of users){
        const li = document.createElement('li'); li.className='item';
        const name = document.createElement('span'); name.textContent = u.username;
        const role = document.createElement('span'); role.className='pill'; role.textContent = u.role;
        const right = document.createElement('span'); right.className='right';
        const reset = document.createElement('button'); reset.className='ghost'; reset.textContent='Jelsz√≥ reset';
        reset.onclick = async ()=>{
          if (session?.role!=='admin') return;
          if (!requirePin('PIN a jelsz√≥ resethez:')) return;
          const np = prompt(`√öj jelsz√≥ a k√∂vetkez≈ëh√∂z: ${u.username}`);
          if (np===null || !np.length) return;
          u.passHash = await sha256(np);
          save('fb_users_v1', users);
          alert('Jelsz√≥ friss√≠tve.');
        };
        const del = document.createElement('button'); del.className='ghost'; del.textContent='T√∂rl√©s';
        del.onclick = ()=>{
          if (session?.role!=='admin') return;
          if (u.id===session.id){ alert('Saj√°t fi√≥k t√∂rl√©se nem enged√©lyezett itt. Jelentkezz be m√°sik adminnal.'); return; }
          const adminCount = users.filter(x=>x.role==='admin').length;
          if (u.role==='admin' && adminCount<=1){ alert('Az utols√≥ admin nem t√∂r√∂lhet≈ë.'); return; }
          if (!requirePin('PIN a felhaszn√°l√≥ t√∂rl√©s√©hez:')) return;
          users = users.filter(x=>x.id!==u.id);
          save('fb_users_v1', users);
          renderUserList();
        };
        li.append(name, role, right, reset, del);
        ul.appendChild(li);
      }
    }

    // ====== App (tasks + shopping) ======
    let tasksByDate = load('fb_tasks_v2', {});   // { "YYYY-MM-DD": [ {id,text,done,time?} ] }
    let shopping    = load('fb_shopping', []);   // [ {id,text,done} ]
    let selected = today();
    let viewMonth = selected.slice(0,7)+'-01';

    const calGrid = $('#calGrid'), monthLabel=$('#monthLabel');
    const list=$('#taskList'), taskInput=$('#taskInput'), taskTime=$('#taskTime');
    const addTask=$('#addTask'), dateOut=$('#dateOut'), clearDoneBtn=$('#clearDone');

    const shopInput=$('#shopInput'), addItem=$('#addItem'), shopList=$('#shopList');

    function timeToMinutes(t){
      if (!t || !/^([01]\d|2[0-3]):[0-5]\d$/.test(t)) return 1e9;
      const [h,m]=t.split(':').map(Number);
      return h*60+m;
    }

    function moveMonth(offset){
      const [y,m]=viewMonth.split('-').map(Number);
      const d=new Date(y,m-1+offset,1);
      viewMonth = ymdOf(new Date(d.getFullYear(), d.getMonth(), 1));
      renderCalendar();
    }

    function renderCalendar(){
      if (!calGrid) return;
      calGrid.innerHTML='';
      DOW.forEach(d=>{const el=document.createElement('div');el.className='dow';el.textContent=d;calGrid.appendChild(el);});
      const [y,m]=viewMonth.split('-').map(Number);
      const first=new Date(y,m-1,1);
      monthLabel.textContent=`${y}. ${first.toLocaleString('hu-HU',{month:'long'})}`;
      const start=new Date(first);
      const shift=(start.getDay()+6)%7; start.setDate(start.getDate()-shift);
      for(let i=0;i<42;i++){
        const d=new Date(start); d.setDate(start.getDate()+i);
        const ymd=ymdOf(d);
        const cell=document.createElement('button'); cell.className='day'; cell.textContent=d.getDate();
        if(d.getMonth()!==first.getMonth())cell.classList.add('out');
        if(ymd===selected)cell.classList.add('selected');
        const arr=(tasksByDate[ymd]||[]);
        if(arr.length){
          const pending = arr.filter(x=>!x.done).length;
          const c=document.createElement('div'); c.className='count'; c.textContent = pending===0 ? '‚úì' : pending;
          cell.appendChild(c);
        }
        cell.onclick=()=>{ selected=ymd; renderCalendar(); renderTasks(); };
        calGrid.appendChild(cell);
      }
    }

    function renderTasks(){
      dateOut.textContent=selected;
      const arr=(tasksByDate[selected]||[]).slice().sort((a,b)=> timeToMinutes(a.time)-timeToMinutes(b.time));
      list.innerHTML='';
      if(!arr.length){ const p=document.createElement('p'); p.textContent='Nincs teend≈ë.'; p.className='muted'; list.appendChild(p); return; }
      for(const t of arr){
        const li=document.createElement('li'); li.className='item'+(t.done?' done':'');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=t.done;
        cb.onchange=()=>{ t.done=!t.done; commitTask(t); };
        const timeBadge=document.createElement('span'); timeBadge.className='badge-time'; timeBadge.textContent = t.time ? `üïí ${t.time}` : '‚Äî';
        const timeEdit=document.createElement('button'); timeEdit.textContent='‚úèÔ∏è'; timeEdit.className='ghost';
        timeEdit.onclick=()=>{
          const nv = prompt('Id≈ë (HH:MM, √ºres = nincs)', t.time || '');
          if(nv===null) return;
          if(nv!=='' && !/^([01]\d|2[0-3]):[0-5]\d$/.test(nv)){ alert('√ârv√©nytelen id≈ë.'); return; }
          t.time = nv; commitTask(t);
        };
        const span=document.createElement('span'); span.className='txt'; span.textContent=t.text;
        const right=document.createElement('span'); right.className='right';
        const del=document.createElement('button'); del.className='ghost'; del.textContent='üóëÔ∏è';
        del.onclick=()=>{ if(!requirePin()) return; removeTask(t.id); };
        li.append(cb, timeBadge, timeEdit, span, right, del);
        list.appendChild(li);
      }
    }

    function commitTask(task){
      const arr = tasksByDate[selected] || [];
      const idx = arr.findIndex(x=>x.id===task.id);
      if (idx>-1) arr[idx]=task;
      save('fb_tasks_v2', tasksByDate);
      renderTasks(); renderCalendar();
    }

    function removeTask(id){
      const arr = tasksByDate[selected] || [];
      const i = arr.findIndex(x=>x.id===id);
      if(i>-1) arr.splice(i,1);
      save('fb_tasks_v2', tasksByDate);
      renderTasks(); renderCalendar();
    }

    addTask.onclick=()=>{
      const text=taskInput.value.trim();
      let time=taskTime.value.trim();
      if(!text) return;
      if(time && !/^([01]\d|2[0-3]):[0-5]\d$/.test(time)) { alert('√ârv√©nytelen id≈ë (HH:MM)'); return; }
      const arr=tasksByDate[selected]||(tasksByDate[selected]=[]);
      arr.push({id:uid(), text, done:false, time: time||""});
      taskInput.value=''; taskTime.value='';
      save('fb_tasks_v2', tasksByDate);
      renderTasks(); renderCalendar();
    };
    taskInput.onkeydown=e=>{if(e.key==='Enter')addTask.click();};
    taskTime.onkeydown=e=>{if(e.key==='Enter')addTask.click();};
    clearDoneBtn.onclick=()=>{
      if(!requirePin()) return;
      const arr = tasksByDate[selected] || [];
      tasksByDate[selected] = arr.filter(t=>!t.done);
      save('fb_tasks_v2', tasksByDate);
      renderTasks(); renderCalendar();
    };

    function renderShopping(){
      shopList.innerHTML='';
      if(!shopping.length){ const p=document.createElement('p'); p.textContent='√úres bev√°s√°rl√≥lista.'; p.className='muted'; shopList.appendChild(p); return; }
      shopping.forEach((i,idx)=>{
        const li=document.createElement('li'); li.className='item'+(i.done?' done':'');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=i.done;
        cb.onchange=()=>{ i.done=!i.done; save('fb_shopping', shopping); renderShopping(); };
        const span=document.createElement('span'); span.className='txt'; span.textContent=i.text;
        const del=document.createElement('button'); del.textContent='üóëÔ∏è'; del.className='ghost';
        del.onclick=()=>{ if(!requirePin()) return; shopping.splice(idx,1); save('fb_shopping', shopping); renderShopping(); };
        li.append(cb, span, del);
        shopList.appendChild(li);
      });
    }

    addItem.onclick=()=>{
      const text=shopInput.value.trim(); if(!text) return;
      shopping.push({id:uid(), text, done:false});
      shopInput.value=''; save('fb_shopping', shopping); renderShopping();
    };
    shopInput.onkeydown=e=>{ if(e.key==='Enter') addItem.click(); };

    $('#prev').onclick = ()=> moveMonth(-1);
    $('#next').onclick = ()=> moveMonth(1);

    function initApp(){
      renderCalendar(); renderTasks(); renderShopping();
      renderUserList(); // if admin
    }

    // Boot flow
    bootAuth();
  </script>
</body>
</html>
