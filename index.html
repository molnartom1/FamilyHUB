<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"/>
<meta name="theme-color" content="#0ea5e9"/>
<title>FamilyBoard v11d-final</title>
<link rel="manifest" href="./manifest.webmanifest?v=11d-final"/>
<!-- ... CSS ugyanaz mint előzőleg ... -->
<!-- kihagyva a helytakarékosság miatt; ugyanaz, mint az előző teljes verzióban -->
</head>
<body>
<header>Family Board
  <button id="darkModeToggle" aria-label="Sötét mód kapcsoló" title="Sötét mód váltó">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 0111.21 3a7 7 0 0010.79 9.79z"></path></svg>
  </button>
</header>

<div id="app" class="center">
  <div id="calendar-header">
    <button id="prevMonth" aria-label="Előző hónap" title="Előző hónap">&lt;</button>
    <span id="currentMonthYear" aria-live="polite"></span>
    <button id="nextMonth" aria-label="Következő hónap" title="Következő hónap">&gt;</button>
  </div>
  <div id="calendar"></div>

  <div class="card" aria-label="Teendő lista">
    <h2>📋 Teendők</h2>
    <div class="row">
      <input type="text" id="taskInput" placeholder="Új teendő…" aria-label="Új teendő" />
      <input type="time" id="taskTimeFrom" aria-label="Időpont tól (HH:MM)" />
      <input type="time" id="taskTimeTo" aria-label="Időpont ig (HH:MM)" />
      <button id="addTask" title="Hozzáadás">+</button>
    </div>
    <ul id="taskList" tabindex="0"></ul>
  </div>

  <div class="card" aria-label="Bevásárlólista">
    <h2>🛒 Bevásárlólista</h2>
    <div class="row">
      <input type="text" id="shoppingInput" placeholder="Új tétel…" aria-label="Új tétel" />
      <button id="addShopping" title="Hozzáadás">+</button>
    </div>
    <ul id="shoppingList" tabindex="0"></ul>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
  getFirestore, enableIndexedDbPersistence, collection, addDoc, updateDoc,
  query, orderBy, onSnapshot, deleteDoc, doc, getDocs
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", () => {
  const firebaseConfig = {
    apiKey: "AIzaSyAeoxtOe5Cleasm3KdeSHP9WDR3PkU-N1I",
    authDomain: "mosas-nyilvantartas.firebaseapp.com",
    projectId: "mosas-nyilvantartas",
    storageBucket: "mosas-nyilvantartas.firebasestorage.app",
    messagingSenderId: "38259241645",
    appId: "1:38259241645:web:26070b1d0686def9f00c24"
  };
  initializeApp(firebaseConfig);
  const auth = getAuth();
  setPersistence(auth, browserLocalPersistence);
  const db = getFirestore();
  enableIndexedDbPersistence(db).catch(() => {});

  const householdId = "default";
  const calendarElem = document.getElementById("calendar");
  const currentMonthYearSpan = document.getElementById("currentMonthYear");
  const prevMonthBtn = document.getElementById("prevMonth");
  const nextMonthBtn = document.getElementById("nextMonth");
  const taskInput = document.getElementById("taskInput");
  const taskTimeFrom = document.getElementById("taskTimeFrom");
  const taskTimeTo = document.getElementById("taskTimeTo");
  const addTask = document.getElementById("addTask");
  const taskList = document.getElementById("taskList");
  const shoppingInput = document.getElementById("shoppingInput");
  const addShopping = document.getElementById("addShopping");
  const shoppingList = document.getElementById("shoppingList");
  const toggleBtn = document.getElementById("darkModeToggle");
  const rootElem = document.documentElement;

  let selectedDate = new Date();
  let selectedYear = selectedDate.getFullYear();
  let selectedMonth = selectedDate.getMonth();
  let monthItemsCount = new Map();

  function formatDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  async function loadMonthItemsCount(year, month) {
    monthItemsCount.clear();
    const tasksRef = collection(db, `households/${householdId}/tasks`);
    const monthStr = `${year}-${String(month + 1).padStart(2, "0")}`;

    await getDocs(tasksRef).then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.date && data.date.startsWith(monthStr) && !data.done) {
          monthItemsCount.set(data.date, (monthItemsCount.get(data.date) || 0) + 1);
        }
      });
    });
  }

  async function createCalendar(year, month) {
    await loadMonthItemsCount(year, month);
    calendarElem.innerHTML = "";

    const daysOfWeek = ["H", "K", "Sze", "Cs", "P", "Szo", "V"];
    daysOfWeek.forEach((day) => {
      const header = document.createElement("div");
      header.textContent = day;
      header.classList.add("day-header");
      calendarElem.appendChild(header);
    });

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
    const daysInMonth = lastDay.getDate();

    const today = new Date();

    for (let i = 0; i < startDay; i++) {
      const emptyCell = document.createElement("div");
      emptyCell.classList.add("day");
      calendarElem.appendChild(emptyCell);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const dayCell = document.createElement("div");
      dayCell.classList.add("day");
      dayCell.textContent = day;

      const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

      if (monthItemsCount.has(dateStr)) {
        const count = monthItemsCount.get(dateStr);
        const dotContainer = document.createElement("div");
        dotContainer.className = "dot-container";

        const nDots = Math.min(count, 3);
        for (let i = 0; i < nDots; i++) {
          const dot = document.createElement("span");
          dot.className = "dot";
          dotContainer.appendChild(dot);
        }
        dayCell.appendChild(dotContainer);

        if (count > 3) {
          const countSpan = document.createElement("div");
          countSpan.className = "count";
          countSpan.textContent = count;
          dayCell.appendChild(countSpan);
        }
      }

      if (year === selectedYear && month === selectedMonth && day === selectedDate.getDate()) {
        dayCell.classList.add("selected");
      }
      if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
        dayCell.classList.add("today");
      }

      dayCell.addEventListener("click", () => {
        selectedDate = new Date(year, month, day);
        selectedYear = year;
        selectedMonth = month;
        updateCurrentMonthYear(selectedYear, selectedMonth);
        createCalendar(selectedYear, selectedMonth);
        loadTasks();
      });

      calendarElem.appendChild(dayCell);
    }
  }

  function updateCurrentMonthYear(year, month) {
    const date = new Date(year, month, 1);
    currentMonthYearSpan.textContent = date.toLocaleDateString("hu-HU", { year: "numeric", month: "long" });
  }

  // ---------------------------
  // TEENDŐK és NAPTÁR FRISSÍTÉS
  // ---------------------------

  function refreshCalendar() {
    updateCurrentMonthYear(selectedYear, selectedMonth);
    createCalendar(selectedYear, selectedMonth);
  }

  prevMonthBtn.addEventListener("click", () => {
    selectedMonth--;
    if (selectedMonth < 0) {
      selectedMonth = 11;
      selectedYear--;
    }
    selectedDate = new Date(selectedYear, selectedMonth, 1);
    refreshCalendar();
    loadTasks();
  });

  nextMonthBtn.addEventListener("click", () => {
    selectedMonth++;
    if (selectedMonth > 11) {
      selectedMonth = 0;
      selectedYear++;
    }
    selectedDate = new Date(selectedYear, selectedMonth, 1);
    refreshCalendar();
    loadTasks();
  });

  let unsubscribeTasks = null, unsubscribeShopping = null;

  function taskTickbox(checked) {
    return `<span class="tickbox${checked ? " checked" : ""}">
      <svg viewBox="0 0 14 12" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="1 7 5.5 11 13 1"></polyline>
      </svg>
    </span>`;
  }

  function renderTasks(tasks) {
    taskList.innerHTML = "";
    tasks.forEach((task) => {
      const li = document.createElement("li");
      if (task.done) li.classList.add("done");
      li.innerHTML =
        taskTickbox(task.done) +
        `<span class="item-text">${(task.timeFrom && task.timeTo ? `[${task.timeFrom} - ${task.timeTo}] ` : "") + task.text}</span>`;
      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.title = "Törlés";
      delBtn.textContent = "✖";
      delBtn.addEventListener("click", async () => {
        const pin = prompt("Add meg a PIN kódot a törléshez:");
        if (pin !== "2025") {
          alert("Hibás PIN kód!");
          return;
        }
        await deleteDoc(doc(db, `households/${householdId}/tasks`, task.docId));
        refreshCalendar();
      });
      li.appendChild(delBtn);
      li.querySelector(".tickbox").addEventListener("click", async () => {
        await updateDoc(doc(db, `households/${householdId}/tasks`, task.docId), {
          done: !task.done,
        });
        refreshCalendar();
      });
      taskList.appendChild(li);
    });
  }

  function renderShopping(items) {
    shoppingList.innerHTML = "";
    items.forEach((item) => {
      const li = document.createElement("li");
      if (item.done) li.classList.add("done");
      li.innerHTML =
        taskTickbox(item.done) +
        `<span class="item-text">${item.text}</span>`;
      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.title = "Törlés";
      delBtn.textContent = "✖";
      delBtn.addEventListener("click", async () => {
        const pin = prompt("Add meg a PIN kódot a törléshez:");
        if (pin !== "2025") {
          alert("Hibás PIN kód!");
          return;
        }
        await deleteDoc(doc(db, `households/${householdId}/shopping`, item.docId));
      });
      li.appendChild(delBtn);
      li.querySelector(".tickbox").addEventListener("click", async () => {
        await updateDoc(doc(db, `households/${householdId}/shopping`, item.docId), {
          done: !item.done,
        });
      });
      shoppingList.appendChild(li);
    });
  }

  function loadTasks() {
    if (unsubscribeTasks) unsubscribeTasks();
    const q = query(collection(db, `households/${householdId}/tasks`), orderBy("createdAt", "desc"));
    unsubscribeTasks = onSnapshot(q, (snapshot) => {
      const dateStr = formatDate(selectedDate);
      const tasks = [];
      snapshot.forEach((doc) => {
        const data = doc.data();
        if (data.date === dateStr) {
          tasks.push({ ...data, docId: doc.id });
        }
      });
      renderTasks(tasks);
    });
  }

  function loadShopping() {
    if (unsubscribeShopping) unsubscribeShopping();
    const q = query(collection(db, `households/${householdId}/shopping`), orderBy("createdAt", "desc"));
    unsubscribeShopping = onSnapshot(q, (snapshot) => {
      const items = [];
      snapshot.forEach((doc) => {
        items.push({ ...doc.data(), docId: doc.id });
      });
      renderShopping(items);
    });
  }

  addTask.addEventListener("click", async () => {
    const text = taskInput.value.trim();
    const timeFrom = taskTimeFrom.value.trim();
    const timeTo = taskTimeTo.value.trim();
    if (!text) return alert("Adj meg egy teendőt!");
    const dateStr = formatDate(selectedDate);
    await addDoc(collection(db, `households/${householdId}/tasks`), {
      text,
      timeFrom: timeFrom || "",
      timeTo: timeTo || "",
      date: dateStr,
      createdAt: Date.now(),
      done: false,
    });
    taskInput.value = "";
    taskTimeFrom.value = "";
    taskTimeTo.value = "";
    refreshCalendar();
  });

  addShopping.addEventListener("click", async () => {
    const text = shoppingInput.value.trim();
    if (!text) return alert("Adj meg egy bevásárló tételt!");
    await addDoc(collection(db, `households/${householdId}/shopping`), {
      text,
      createdAt: Date.now(),
      done: false,
    });
    shoppingInput.value = "";
  });

  async function init() {
    await signInAnonymously(auth);
    updateCurrentMonthYear(selectedYear, selectedMonth);
    await createCalendar(selectedYear, selectedMonth);
    loadTasks();
    loadShopping();
  }

  onAuthStateChanged(auth, (user) => {
    if (user) {
      init();
    } else {
      signInAnonymously(auth);
    }
  });

  // DARK MODE LOGIKA
  if (localStorage.getItem("theme")) {
    rootElem.setAttribute("data-theme", localStorage.getItem("theme"));
  }
  toggleBtn.addEventListener("click", () => {
    const currentTheme = rootElem.getAttribute("data-theme");
    if (currentTheme === "dark") {
      rootElem.removeAttribute("data-theme");
      localStorage.setItem("theme", "light");
    } else {
      rootElem.setAttribute("data-theme", "dark");
      localStorage.setItem("theme", "dark");
    }
  });
});
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js?v=11d-final");
}
</script>
</body>
</html>
