<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FamilyHub • Napi Kör — Családi PWA</title>
  <meta name="description" content="Családi irányítópult + közös naptár, offline-first PWA, opcionális Google Calendar szinkronhoz előkészítve." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%230bb'/%3E%3Cpath d='M32 72c8-20 56-20 64 0-4 20-60 20-64 0z' fill='%23fff'/%3E%3Ccircle cx='48' cy='52' r='8' fill='%23fff'/%3E%3Ccircle cx='80' cy='52' r='8' fill='%23fff'/%3E%3C/svg%3E" />
  <style>
    :root{--bg:#0b1020;--card:#121a2f;--muted:#8aa1c0;--text:#e6eefb;--accent:#4cc9f0;--accent2:#b5179e;--ok:#2bd576;--warn:#f0c419;--danger:#ff5d6c}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji';background:linear-gradient(180deg,#0b1020,#0e1530);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:rgba(11,16,32,.8);backdrop-filter:blur(8px);border-bottom:1px solid #1f2a44;z-index:10}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px}
    .brand h1{font-size:18px;margin:0}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 300px}
    .card{background:linear-gradient(180deg,#121a2f,#0f182d);border:1px solid #1f2a44;border-radius:16px;padding:16px;box-shadow:0 2px 24px rgba(0,0,0,.25)}
    .muted{color:var(--muted)}
    button,.btn{background:linear-gradient(180deg,#1a2442,#152039);border:1px solid #2a3a62;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{border-color:#4cc9f0}
    input,select,textarea{width:100%;background:#0e1530;border:1px solid #243357;color:var(--text);padding:10px;border-radius:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .tab{padding:10px 12px;border-radius:999px;background:#111a31;border:1px solid #25345a;cursor:pointer;color:#b7c6e3}
    .tab.active{background:linear-gradient(180deg,#182346,#141f3b);color:#fff;border-color:#4cc9f0}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#111a31;border:1px solid #25345a;color:#9fb2d6}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;gap:10px;background:#0f1730;border:1px solid #25345a;padding:10px;border-radius:12px}
    .item input[type=checkbox]{transform:scale(1.2)}
    .tag{padding:2px 8px;border-radius:999px;border:1px solid #334770;color:#c9defb;background:#0b142c;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .footer{margin:24px 0;color:#7f93bb;font-size:12px;text-align:center}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .hidden{display:none !important}
    .divider{height:1px;background:#22345f;margin:12px 0;border:0}
    .avatar{width:24px;height:24px;border-radius:50%;display:inline-block}
    .color{appearance:none;width:44px;height:32px;border-radius:8px;border:1px solid #25406f;background:transparent}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;background:#0b142c;border:1px solid #2b426e;padding:2px 6px;border-radius:6px}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-cell{background:#0f1730;border:1px solid #25345a;border-radius:10px;padding:8px;min-height:80px}
    .cal-cell .d{font-size:12px;color:#93abd4}
    .cal-evt{margin-top:6px;font-size:12px;padding:4px 6px;border:1px solid #34568a;border-radius:8px;background:#0b142c}
    .toast{position:fixed;bottom:16px;right:16px;background:#0f1730;border:1px solid #27406b;padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .net{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2b3e67}
    .net.online{background:#0f2a2a;border-color:#1f5f5f;color:#b6fff2}
    .net.offline{background:#2a0f0f;border-color:#5f1f1f;color:#ffd6d6}
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 16px;">
      <div class="brand">
        <img class="logo" alt="logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%230bb'/%3E%3Cpath d='M32 72c8-20 56-20 64 0-4 20-60 20-64 0z' fill='%23fff'/%3E%3Ccircle cx='48' cy='52' r='8' fill='%23fff'/%3E%3Ccircle cx='80' cy='52' r='8' fill='%23fff'/%3E%3C/svg%3E" />
        <h1>FamilyHub • Napi Kör</h1>
      </div>
      <div class="inline">
        <span class="pill"><span id="familyNameLabel">Család</span></span>
        <span id="netBadge" class="net">ellenőrzés…</span>
        <button id="installBtn" class="btn">Telepítés (PWA)</button>
        <button id="notifBtn" class="btn">Értesítések bekapcsolása</button>
        <button id="exportBtn" class="btn">Export / Mentés</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div class="tabs" id="tabs"></div>
      <div id="view-dashboard" class="view"></div>
      <div id="view-calendar" class="view hidden"></div>
      <div id="view-tasks" class="view hidden"></div>
      <div id="view-shopping" class="view hidden"></div>
      <div id="view-wall" class="view hidden"></div>
      <div id="view-settings" class="view hidden"></div>
    </div>
    <div class="footer">Offline-first PWA • ICS import/export • Opcionális Google Calendar szinkron előkészítve • Helyi értesítések + alap push előkészítés • <span class="muted">Hibrid offline: App Shell + Offline fallback</span></div>
  </main>

  <template id="tpl-dashboard">
    <div class="row">
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 8px">Mai teendők</h3>
          <div id="dash-tasks"></div>
          <div class="divider"></div>
          <div class="inline" style="gap:8px">
            <input id="newTaskTitle" placeholder="Új teendő..." />
            <button id="addTaskBtn">Hozzáadás</button>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 8px">Közelgő események</h3>
          <div id="dash-events"></div>
          <div class="divider"></div>
          <div class="grid">
            <div>
              <label>Cím</label>
              <input id="evtTitle" placeholder="Pl. Orvos, szülői, edzés" />
            </div>
            <div>
              <label>Dátum</label>
              <input id="evtDate" type="date" />
            </div>
            <div>
              <label>Kezdés</label>
              <input id="evtStart" type="time" />
            </div>
            <div>
              <label>Vége</label>
              <input id="evtEnd" type="time" />
            </div>
            <div>
              <label>Megjegyzés</label>
              <input id="evtNote" placeholder="Opció" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="addEvtBtn">Esemény hozzáadása</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-calendar">
    <div class="inline" style="justify-content:space-between;width:100%">
      <div class="inline">
        <button id="prevMonth">◀</button>
        <div class="pill" id="monthLabel">2025-10</div>
        <button id="nextMonth">▶</button>
      </div>
      <div class="inline">
        <button id="icsExport">ICS export</button>
        <label class="btn" for="icsImportFile">ICS import</label>
        <input id="icsImportFile" type="file" accept=".ics,text/calendar" class="hidden" />
        <button id="gcalSync" title="Google Calendar szinkron (opcionális)">Google szinkron (beta)</button>
      </div>
    </div>
    <div class="calendar" id="calGrid"></div>
  </template>

  <template id="tpl-tasks">
    <div class="inline" style="justify-content:space-between;width:100%">
      <div class="pill">Összes teendő</div>
      <div class="inline">
        <select id="taskFilter">
          <option value="all">Mind</option>
          <option value="open">Nyitott</option>
          <option value="done">Kész</option>
        </select>
        <button id="clearDone">Kész elemek törlése</button>
      </div>
    </div>
    <div class="divider"></div>
    <div class="inline" style="gap:8px;margin-bottom:8px">
      <input id="taskTitle" placeholder="Teendő címe" />
      <select id="taskAssignee"></select>
      <button id="taskAdd">Hozzáadás</button>
    </div>
    <div id="taskList" class="list"></div>
  </template>

  <template id="tpl-shopping">
    <div class="inline" style="gap:8px;margin-bottom:8px">
      <input id="shopTitle" placeholder="Tétel (pl. tej)" />
      <input id="shopQty" placeholder="Mennyiség (pl. 2)" style="max-width:120px" />
      <select id="shopCat">
        <option>Élelmiszer</option>
        <option>Háztartás</option>
        <option>Gyerek</option>
        <option>Egyéb</option>
      </select>
      <button id="shopAdd">Hozzáadás</button>
      <button id="shopClearBought">Megvett törlése</button>
    </div>
    <div id="shopList" class="list"></div>
  </template>

  <template id="tpl-wall">
    <div class="inline" style="gap:8px;margin-bottom:8px">
      <input id="wallMsg" placeholder="Üzenj a családnak..." />
      <button id="wallSend">Küldés</button>
    </div>
    <div id="wallFeed" class="list"></div>
  </template>

  <template id="tpl-settings">
    <div class="grid">
      <div class="card">
        <h3>Család beállítások</h3>
        <label>Család neve</label>
        <input id="familyName" placeholder="Pl. Kovács család" />
        <div class="divider"></div>
        <h4>Tagok</h4>
        <div id="members"></div>
        <div class="inline" style="gap:8px;margin-top:8px">
          <input id="memberName" placeholder="Új családtag neve" />
          <input id="memberEmoji" placeholder="Emoji (pl. 😀)" style="max-width:120px" />
          <input id="memberColor" type="color" class="color" value="#4cc9f0"/>
          <button id="addMember">Hozzáadás</button>
        </div>
      </div>
      <div class="card">
        <h3>Szinkron & értesítések</h3>
        <p class="muted">Google Calendar szinkron (beta):
          <br/><span class="kbd">Bejelentkezés → naptár kiválasztás → egyirányú import</span>
        </p>
        <button id="btnGoogleSignIn">Google bejelentkezés (demo)</button>
        <button id="btnGoogleImport">Google naptár import (demo)</button>
        <div class="divider"></div>
        <p class="muted">Web Push előkészítés (szerver szükséges VAPID kulccsal). Helyi értesítések működnek.</p>
        <button id=\"btnTestNotify\">Teszt értesítés<\/button>
        <div class=\"divider\"></div>
        <h4>Web Push (beta)</h4>
        <div class=\"inline\" style=\"gap:8px;flex-wrap:wrap\">
          <button id=\"btnPushEnable\">Push engedélyezés</button>
          <button id=\"btnPushDisable\">Push leiratkozás</button>
          <button id=\"btnPushTest\">Push teszt (szerver)</button>
        </div>
        <div class="divider"></div>
        <h4>Diagnosztika</h4>
        <div class="inline" style="gap:8px;flex-wrap:wrap">
          <button id="btnTestSW">Service Worker teszt</button>
          <button id="btnSelfTestICS">ICS körteszt</button>
          <button id="btnOpenOfflineTest">Offline fallback teszt</button>
          <button id="btnUnregSW" class="btn">SW eltávolítás</button>
          <button id="btnClearCaches" class="btn">Cache ürítés</button>
          <button id="btnFactoryReset" class="btn" title="SW + cache + adatok törlése">Gyári visszaállítás</button>
        </div>
        <small class="muted">Ha a vászon (blob: URL) miatt nincs SW, futtasd localhoston vagy https alatt. A fenti gombok segítenek egy elrontott cache/SW állapotot helyrehozni.</small>
      </div>
    </div>
  </template>

  <div id="toast" class="toast hidden"></div>

  <script>
  /* ==========================
     FamilyHub • Napi Kör — Core (stabil, vászonbarát)
     - Vásznon/blob/file környezetben SW automatikusan KIKAPCSOLVA
     - GitHub Pages-en sw.js fájllal, helyes BASE scope-pal
     ========================== */

  const App = (() => {
    const state = {
      family: { id: 'family-001', name: 'Család', members: [
        { id: 'm1', name: 'Anya', emoji: '👩', color: '#ff5d6c'},
        { id: 'm2', name: 'Apa', emoji: '👨', color: '#4cc9f0'}
      ]},
      tasks: [], shopping: [], wall: [], events: [], monthOffset: 0,
    };

    // ---------- utils ----------
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, children=[]) => { const n=document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{ if(k==='class') n.className=v; else if(k==='html') n.innerHTML=v; else if(k.startsWith('on')) n.addEventListener(k.slice(2), v); else n.setAttribute(k,v); });
      children.forEach(c=>n.append(c)); return n; };
    const id = (pfx='id') => pfx + Math.random().toString(36).slice(2,9);
    const toast = (msg) => { const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2500); };
    const save = () => localStorage.setItem('familyhub.data', JSON.stringify(state));
    const load = () => { const raw=localStorage.getItem('familyhub.data'); if(raw){ try{ Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn('Load failed', e); } } };

    // ---------- network badge ----------
    function updateNet(){ const b=document.getElementById('netBadge'); if(!b) return; if(navigator.onLine){ b.textContent='online'; b.classList.add('online'); b.classList.remove('offline'); } else { b.textContent='offline'; b.classList.add('offline'); b.classList.remove('online'); } }
    addEventListener('online', updateNet); addEventListener('offline', updateNet);

    // ---------- notifications ----------
    async function ensureNotifications(){ if(!('Notification' in window)) { toast('Nincs értesítés támogatás.'); return false; } if(Notification.permission==='granted') return true; const perm=await Notification.requestPermission(); return perm==='granted'; }
    function notifyLocal(title, body){ try{ if(Notification.permission==='granted') new Notification(title, { body }); }catch{} toast(body); if(navigator.serviceWorker?.controller){ navigator.serviceWorker.controller.postMessage({type:'notify', title, body}); } }

    // ---------- tabs + views ----------
    const tabs = [
      { id:'dashboard', name:'Irányítópult'},
      { id:'calendar', name:'Naptár'},
      { id:'tasks', name:'Teendők'},
      { id:'shopping', name:'Bevásárló'},
      { id:'wall', name:'Üzenőfal'},
      { id:'settings', name:'Beállítások'},
    ];
    function renderTabs(active='dashboard'){ const wrap=document.getElementById('tabs'); if(!wrap) return; wrap.innerHTML=''; tabs.forEach(t=>{ const b=el('button',{class:'tab'+(t.id===active?' active':''), onclick:()=>switchView(t.id)},[t.name]); wrap.append(b); }); }
    function switchView(view){ document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden')); const tgt=document.getElementById('view-'+view); if(tgt) tgt.classList.remove('hidden'); renderTabs(view); ({dashboard:renderDashboard,calendar:renderCalendar,tasks:renderTasks,shopping:renderShopping,wall:renderWall,settings:renderSettings})[view]?.(); }

    // ---------- dashboard ----------
    function memberPill(mid){ const m=state.family.members.find(x=>x.id===mid); return m? `<span class="tag" style="border-color:${m.color};">${m.emoji||'👤'} ${m.name}</span>` : '<span class="tag">Ismeretlen</span>'; }
    function renderDashboard(){
      const root=document.getElementById('view-dashboard'); if(!root) return; root.innerHTML=document.getElementById('tpl-dashboard').innerHTML;
      const openTasks = state.tasks.filter(t=>!t.done).slice(0,5);
      const list = el('div',{class:'list'});
      openTasks.forEach(t=>{
        const it=el('div',{class:'item'});
        const chk=el('input',{type:'checkbox', onchange:()=>{t.done=true; save(); renderDashboard(); notifyLocal('Teendő kész', t.title);}});
        const meta=el('div',{},[ el('div',{html:`<strong>${t.title}</strong>`}), el('div',{class:'muted', html:`${memberPill(t.assignee)} • ${new Date(t.created).toLocaleString()}`}) ]);
        it.append(chk, meta); list.append(it);
      });
      const anchor=document.getElementById('dash-tasks'); if(anchor) anchor.replaceWith(list);

      const now = new Date(); const in7 = new Date(now.getTime()+7*86400000);
      const upcoming = state.events.filter(e=> new Date(e.start) <= in7 && new Date(e.end||e.start) >= now).sort((a,b)=> new Date(a.start)-new Date(b.start)).slice(0,5);
      const evWrap=el('div',{class:'list'});
      upcoming.forEach(e=>{ const it=el('div',{class:'item'}); it.append(el('div',{class:'tag', html:new Date(e.start).toLocaleString()}), el('div',{html:`<strong>${e.title}</strong> <span class=\"muted\">${e.note? '• '+e.note:''}</span>`})); evWrap.append(it); });
      const evAnchor=document.getElementById('dash-events'); if(evAnchor) evAnchor.replaceWith(evWrap);

      document.getElementById('addTaskBtn').onclick = () => {
        const val=document.getElementById('newTaskTitle').value.trim(); if(!val) return; const assignee = state.family.members[0]?.id;
        state.tasks.unshift({ id:id('t'), title:val, assignee, done:false, created:Date.now() });
        save(); renderDashboard(); notifyLocal('Új teendő', val);
        document.getElementById('newTaskTitle').value='';
      };
      document.getElementById('addEvtBtn').onclick = () => {
        const title=document.getElementById('evtTitle').value.trim();
        const date=document.getElementById('evtDate').value; const s=document.getElementById('evtStart').value; const e=document.getElementById('evtEnd').value; const note=document.getElementById('evtNote').value.trim();
        if(!title || !date) return toast('Cím és dátum kötelező');
        const start = new Date(`${date}T${s||'09:00'}:00`);
        const end = new Date(`${date}T${e||s||'10:00'}:00`);
        state.events.push({ id:id('e'), title, start, end, note });
        save(); renderDashboard(); notifyLocal('Új esemény', `${title} • ${start.toLocaleString()}`);
        document.getElementById('evtTitle').value=''; document.getElementById('evtNote').value='';
      };
    }

    // ---------- calendar ----------
    function monthStart(offset){ const d=new Date(); d.setDate(1); d.setMonth(d.getMonth()+offset); return d; }
    function daysInMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); }
    function renderCalendar(){
      const root=document.getElementById('view-calendar'); if(!root) return; root.innerHTML=document.getElementById('tpl-calendar').innerHTML;
      const base = monthStart(state.monthOffset); const y=base.getFullYear(), m=base.getMonth();
      document.getElementById('monthLabel').textContent = base.toLocaleString('hu-HU', { month:'long', year:'numeric'});
      const grid=document.getElementById('calGrid'); grid.innerHTML='';
      const firstDow=(new Date(y,m,1).getDay()||7)-1; for(let i=0;i<firstDow;i++) grid.append(el('div',{class:'cal-cell muted'}));
      const days=daysInMonth(base);
      for(let d=1; d<=days; d++){
        const cell = el('div', {class:'cal-cell'});
        const date = new Date(y,m,d);
        cell.append(el('div', {class:'d', html: date.toLocaleDateString('hu-HU', {weekday:'short'})+' • '+d}));
        const todays = state.events.filter(e=> new Date(e.start).toDateString()===date.toDateString());
        todays.forEach(ev=> cell.append(el('div',{class:'cal-evt', html:`<strong>${ev.title}</strong><br/><span class=\"muted\">${new Date(ev.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}${ev.end? '–'+new Date(ev.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}):''}</span>`})) );
        grid.append(cell);
      }
      document.getElementById('prevMonth').onclick=()=>{state.monthOffset--; renderCalendar();};
      document.getElementById('nextMonth').onclick=()=>{state.monthOffset++; renderCalendar();};
      document.getElementById('icsExport').onclick=exportICS;
      document.getElementById('icsImportFile').addEventListener('change', importICS);
      document.getElementById('gcalSync').onclick=googleImportDemo;
    }

    // ---------- ICS ----------
    function exportICS(){ const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//FamilyHub//HU//']; state.events.forEach(e=>{ lines.push('BEGIN:VEVENT'); lines.push('UID:'+e.id+'@familyhub'); const dt=d=> new Date(d).toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z'); lines.push('DTSTART:'+dt(e.start)); if(e.end) lines.push('DTEND:'+dt(e.end)); lines.push('SUMMARY:'+escapeICS(e.title)); if(e.note) lines.push('DESCRIPTION:'+escapeICS(e.note)); lines.push('END:VEVENT'); }); lines.push('END:VCALENDAR'); const blob=new Blob([lines.join('\n')],{type:'text/calendar'}); const a=el('a',{href:URL.createObjectURL(blob),download:'familyhub.ics'}); a.click(); }
    function escapeICS(s){ return String(s).replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;'); }
    async function importICS(ev){ const file=ev.target.files[0]; if(!file) return; const text=await file.text(); const items=[]; let cur=null; text.split(/\r?\n/).forEach(line=>{ if(line==='BEGIN:VEVENT'){ cur={}; } else if(line==='END:VEVENT'){ if(cur?.title && cur?.start){ items.push(cur);} cur=null; } else if(cur){ if(line.startsWith('SUMMARY:')) cur.title=unESC(line.slice(8)); else if(line.startsWith('DTSTART:')) cur.start=icsToDate(line.slice(8)); else if(line.startsWith('DTEND:')) cur.end=icsToDate(line.slice(6)); else if(line.startsWith('DESCRIPTION:')) cur.note=unESC(line.slice(12)); } }); state.events.push(...items.map(e=>({id:id('e'), ...e}))); save(); renderCalendar(); notifyLocal('ICS import kész', `${items.length} esemény hozzáadva`); ev.target.value=''; function unESC(s){return s.replace(/\\n/g,'\n').replace(/\\,/g,',').replace(/\\;/g,';').replace(/\\\\/g,'\\');} function icsToDate(s){ const m=/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z/.exec(s); return m? new Date(Date.UTC(+m[1],+m[2]-1,+m[3],+m[4],+m[5],+m[6])) : new Date(s); } }

    // ---------- tasks ----------
    function renderTasks(){ const root=document.getElementById('view-tasks'); if(!root) return; root.innerHTML=document.getElementById('tpl-tasks').innerHTML; const sel=document.getElementById('taskAssignee'); sel.innerHTML=''; state.family.members.forEach(m=> sel.append(el('option',{value:m.id},[m.name]))); const draw=()=>{ const filter=document.getElementById('taskFilter').value; const wrap=document.getElementById('taskList'); wrap.innerHTML=''; state.tasks.filter(t=> filter==='all'||(filter==='open'&&!t.done)||(filter==='done'&&t.done)).forEach(t=>{ const it=el('div',{class:'item'}); const chk=el('input',{type:'checkbox'}); chk.checked=t.done; chk.onchange=()=>{t.done=chk.checked; save(); draw();}; const meta=el('div',{},[ el('div',{html:`<strong>${t.title}</strong> ${memberPill(t.assignee)}`}), el('div',{class:'muted',html:new Date(t.created).toLocaleString()}) ]); const del=el('button',{onclick:()=>{ state.tasks=state.tasks.filter(x=>x.id!==t.id); save(); draw(); }},['Törlés']); it.append(chk, meta, del); wrap.append(it); }); }; draw(); document.getElementById('taskAdd').onclick=()=>{ const title=document.getElementById('taskTitle').value.trim(); if(!title) return; const assignee=document.getElementById('taskAssignee').value; state.tasks.unshift({id:id('t'), title, assignee, done:false, created:Date.now()}); save(); draw(); notifyLocal('Új teendő', title); document.getElementById('taskTitle').value=''; }; document.getElementById('taskFilter').onchange=draw; document.getElementById('clearDone').onclick=()=>{ state.tasks=state.tasks.filter(t=>!t.done); save(); draw(); } }

    // ---------- shopping ----------
    function renderShopping(){ const root=document.getElementById('view-shopping'); if(!root) return; root.innerHTML=document.getElementById('tpl-shopping').innerHTML; const draw=()=>{ const wrap=document.getElementById('shopList'); wrap.innerHTML=''; state.shopping.forEach(itm=>{ const it=el('div',{class:'item'}); const chk=el('input',{type:'checkbox'}); chk.checked=!!itm.bought; chk.onchange=()=>{itm.bought=chk.checked; save(); draw();}; const meta=el('div',{},[ el('div',{html:`<strong>${itm.title}</strong> <span class=\"muted\">${itm.qty||''} ${itm.cat? '• '+itm.cat:''}</span>`}), el('div',{class:'muted',html:`${memberPill(itm.by)} • ${new Date(itm.created).toLocaleString()}`}) ]); const del=el('button',{onclick:()=>{state.shopping=state.shopping.filter(x=>x.id!==itm.id); save(); draw();}},['Törlés']); it.append(chk, meta, del); wrap.append(it); }); }; draw(); document.getElementById('shopAdd').onclick=()=>{ const title=document.getElementById('shopTitle').value.trim(); if(!title) return; const qty=document.getElementById('shopQty').value.trim(); const cat=document.getElementById('shopCat').value; const by=state.family.members[0]?.id; state.shopping.unshift({id:id('s'), title, qty, cat, by, created:Date.now()}); save(); draw(); notifyLocal('Bevásárlólista', `${title}${qty?' × '+qty:''}`); document.getElementById('shopTitle').value=''; document.getElementById('shopQty').value=''; }; document.getElementById('shopClearBought').onclick=()=>{ state.shopping=state.shopping.filter(i=>!i.bought); save(); draw(); } }

    // ---------- wall ----------
    function renderWall(){ const root=document.getElementById('view-wall'); if(!root) return; root.innerHTML=document.getElementById('tpl-wall').innerHTML; const draw=()=>{ const wrap=document.getElementById('wallFeed'); wrap.innerHTML=''; state.wall.slice(0,100).forEach(w=>{ const it=el('div',{class:'item'}); it.append(el('div',{class:'avatar', style:`background:${(state.family.members.find(m=>m.id===w.by)?.color)||'#333'}`}), el('div',{},[ el('div',{html:`<strong>${state.family.members.find(m=>m.id===w.by)?.name||'Ismeretlen'}</strong> <span class='muted'>${new Date(w.at).toLocaleString()}</span>`}), el('div',{html:w.text}) ])); wrap.append(it); }); }; draw(); document.getElementById('wallSend').onclick=()=>{ const text=document.getElementById('wallMsg').value.trim(); if(!text) return; const by=state.family.members[0]?.id; state.wall.unshift({id:id('w'), text, by, at:Date.now()}); save(); draw(); notifyLocal('Új üzenet', text); document.getElementById('wallMsg').value=''; } }

    // ---------- settings ----------
    function renderSettings(){ const root=document.getElementById('view-settings'); if(!root) return; root.innerHTML=document.getElementById('tpl-settings').innerHTML; document.getElementById('familyName').value=state.family.name||''; document.getElementById('familyName').oninput=e=>{ state.family.name=e.target.value; document.getElementById('familyNameLabel').textContent=state.family.name||'Család'; save(); }; const list=document.getElementById('members'); list.innerHTML=''; state.family.members.forEach(m=>{ const row=el('div',{class:'item'},[ el('span',{class:'avatar', style:`background:${m.color}`}), el('div',{},[el('div',{html:`<strong>${m.name}</strong> <span class='muted'>${m.emoji||''}</span>`})]), el('button',{onclick:()=>{ state.tasks.forEach(t=>{ if(t.assignee===m.id) t.assignee=state.family.members[0]?.id; }); state.family.members=state.family.members.filter(x=>x.id!==m.id); save(); renderSettings(); }},['Eltávolítás']) ]); list.append(row); }); document.getElementById('addMember').onclick=()=>{ const name=document.getElementById('memberName').value.trim(); if(!name) return; const emoji=document.getElementById('memberEmoji').value.trim(); const color=document.getElementById('memberColor').value; state.family.members.push({id:id('m'), name, emoji, color}); save(); renderSettings(); document.getElementById('memberName').value=''; document.getElementById('memberEmoji').value=''; }; document.getElementById('btnGoogleSignIn').onclick=()=>toast('Demo: itt jelenne meg a Google bejelentkezés (OAuth)'); document.getElementById('btnGoogleImport').onclick=googleImportDemo; document.getElementById('btnTestNotify').onclick=()=>notifyLocal('FamilyHub','Ez egy teszt értesítés.');
      // Web Push gombok
      document.getElementById('btnPushEnable').onclick=pushEnable;
      document.getElementById('btnPushDisable').onclick=pushDisable;
      document.getElementById('btnPushTest').onclick=pushTest; document.getElementById('btnTestSW').onclick=testSW; document.getElementById('btnSelfTestICS').onclick=selfTestICS; document.getElementById('btnOpenOfflineTest').onclick=()=>{ const path='/offline-test-'+Math.random().toString(36).slice(2,6); const isBlob=location.protocol==='blob:'; const isFile=location.protocol==='file:'; const isOpaque=location.origin==='null'; const BASE=(isBlob||isFile||isOpaque)? '/' : (location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/[^/]+$/, '')); const full=BASE+path.replace(/^\//,''); window.open(full, '_blank'); }; document.getElementById('btnUnregSW').onclick=unregisterAllSW; document.getElementById('btnClearCaches').onclick=clearAllCaches; document.getElementById('btnFactoryReset').onclick=async()=>{ await unregisterAllSW(); await clearAllCaches(); localStorage.removeItem('familyhub.data'); toast('Gyári visszaállítás kész. Frissítés…'); setTimeout(()=>location.reload(),600); }; }

    // ---------- Web Push kliens (beta) ----------
    const SERVER_BASE = 'https://YOUR-PUSH-SERVER.example.com'; // <-- Állítsd be a saját szervered URL-jére
    async function getVapidKey(){ const r=await fetch(SERVER_BASE+'/vapid/public'); if(!r.ok) throw new Error('VAPID kulcs hiba'); const {publicKey}=await r.json(); return urlBase64ToUint8Array(publicKey); }
    function urlBase64ToUint8Array(base64String){ const padding='='.repeat((4-base64String.length%4)%4); const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/'); const raw=atob(base64); const out=new Uint8Array(raw.length); for(let i=0;i<raw.length;i++) out[i]=raw.charCodeAt(i); return out; }
    async function pushEnable(){ try{ if(!('serviceWorker' in navigator) || !('PushManager' in window)) return toast('Push nem támogatott'); const reg=await navigator.serviceWorker.ready; const appKey=await getVapidKey(); const sub=await reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey: appKey }); await fetch(SERVER_BASE+'/subscribe',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(sub) }); toast('Push feliratkozás kész'); }catch(e){ console.error(e); toast('Push engedélyezés hiba'); } }
    async function pushDisable(){ try{ const reg=await navigator.serviceWorker.ready; const sub=await reg.pushManager.getSubscription(); if(sub){ await fetch(SERVER_BASE+'/unsubscribe',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(await sub.toJSON()) }); await sub.unsubscribe(); } toast('Push leiratkozva'); }catch(e){ console.error(e); toast('Leiratkozás hiba'); } }
    async function pushTest(){ try{ await fetch(SERVER_BASE+'/notify',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title:'FamilyHub', body:'Szerver küldte ezt a teszt push-t.' }) }); toast('Teszt push elküldve'); }catch(e){ console.error(e); toast('Teszt push hiba'); } }

    // ---------- demos ----------
    async function googleImportDemo(){ toast('Demo: Google Calendar import helykitöltő. ICS export/import működik.'); }

    // ---------- export all ----------
    function exportAll(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=el('a',{href:URL.createObjectURL(blob), download:`FamilyHub_backup_${new Date().toISOString().slice(0,10)}.json`}); a.click(); }

    // ---------- PWA register (vászonbarát) ----------
    function registerPWA(){
      const isBlob=location.protocol==='blob:'; const isFile=location.protocol==='file:'; const isOpaque=location.origin==='null';
      const isSandbox=isBlob||isFile||isOpaque;
      const BASE = isSandbox ? '/' : (location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, ''));

      // Manifest (mindig mehet)
      const manifest={ name:'FamilyHub • Napi Kör', short_name:'FamilyHub', start_url:BASE, scope:BASE, display:'standalone', background_color:'#0b1020', theme_color:'#0b1020', icons:[192,512].map(sz=>({src:svgIconDataURI(), sizes:`${sz}x${sz}`, type:'image/png', purpose:'any maskable'})) };
      const mURL=URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'})); const link=document.createElement('link'); link.rel='manifest'; link.href=mURL; document.head.appendChild(link);

      if(isSandbox){ console.warn('Sandbox/vászon: SW tiltva, app fut SW nélkül.'); toast('Vászon módban az SW kikapcsolva — ez normális.'); return; }

      if('serviceWorker' in navigator){
        const swURL = new URL('sw.js', location.origin + BASE).toString();
        navigator.serviceWorker.register(swURL, {scope: BASE}).then(reg=>console.info('SW reg OK:',reg.scope))
        .catch(err=>{ console.error('SW reg error',err); toast('SW reg hiba: hiányzik a sw.js a '+BASE+' alatt?'); });
        // letöltő helper Pages-hez
        window.__FHUB_DOWNLOAD_SW__ = ()=>{ const code=makeSWCodeFromScope(BASE); const blob=new Blob([code],{type:'application/javascript'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sw.js'; a.click(); };
      }
    }

    function svgIconDataURI(){ const svg=`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><defs><linearGradient id='g' x1='0' x2='0' y1='0' y2='1'><stop offset='0%' stop-color='%234cc9f0'/><stop offset='100%' stop-color='%23b5179e'/></linearGradient></defs><rect rx='30' width='128' height='128' fill='url(%23g)'/><circle cx='43' cy='54' r='10' fill='white'/><circle cx='85' cy='54' r='10' fill='white'/><path d='M30 80c10-18 58-18 68 0-6 22-62 22-68 0z' fill='white'/></svg>`; return 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svg); }

    function makeSWCodeFromScope(BASE){
      const offlineHTML=`<!doctype html><html lang="hu"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Offline • FamilyHub</title><style>body{margin:0;font-family:system-ui,Segoe UI,Roboto;background:#0b1020;color:#e6eefb;display:grid;place-items:center;height:100vh}.box{max-width:560px;padding:24px;border:1px solid #27406b;border-radius:16px;background:#0f1730;box-shadow:0 10px 40px rgba(0,0,0,.35)}h1{margin:0 0 8px}p{color:#9fb2d6}button{padding:10px 14px;border-radius:12px;border:1px solid #2a3a62;background:#152039;color:#fff;cursor:pointer}button:active{transform:translateY(1px)}</style></head><body><div class="box"><h1>Offline mód</h1><p>Úgy tűnik, nincs hálózati kapcsolat és ez az oldal még nincs a gyorsítótárban.</p><p>Próbáld meg újra, vagy térj vissza a kezdőlapra.</p><div style="display:flex;gap:8px;margin-top:12px"><button onclick="location.reload()">Próbáld újra</button><button onclick="location.href='${BASE}'">Kezdőlap</button></div></div></body></html>`;
      return `
const CACHE='familyhub-v5';
const SCOPE_URL=new URL(self.registration.scope); let BASE=SCOPE_URL.pathname; if(!BASE.endsWith('/')) BASE+='/';
self.addEventListener('install',e=>{ self.skipWaiting(); e.waitUntil(caches.open(CACHE).then(c=>c.addAll([BASE, BASE+'index.html']).catch(()=>{}))); });
self.addEventListener('activate',e=>{ self.clients.claim(); e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))); });
self.addEventListener('fetch',e=>{ const req=e.request; if(req.mode==='navigate'){ e.respondWith((async()=>{ try{ const net=await fetch(req); if(!net.ok) throw new Error('HTTP '+net.status); const copy=net.clone(); caches.open(CACHE).then(c=>c.put(req,copy)); return net; }catch(err){ const cached=await caches.match(req)||await caches.match(BASE)||await caches.match(BASE+'index.html'); if(cached) return cached; return new Response(${JSON.stringify(offlineHTML)},{headers:{'Content-Type':'text/html; charset=utf-8'}}); } })()); return; } e.respondWith((async()=>{ const cached=await caches.match(req); if(cached) return cached; try{ const net=await fetch(req); if(!net.ok) throw new Error('HTTP '+net.status); const copy=net.clone(); caches.open(CACHE).then(c=>c.put(req,copy)); return net; }catch(err){ throw err; } })()); });
// Push érkezése → natív értesítés
self.addEventListener('push', e=>{ let data={}; try{ data=e.data? e.data.json() : {}; }catch{} const title=data.title||'FamilyHub'; const body=data.body||''; const url=data.url||null; const opts={ body, data:{ url }, requireInteraction:false }; e.waitUntil(self.registration.showNotification(title, opts)); });
// Kattintás → fókuszálás / megnyitás
self.addEventListener('notificationclick', e=>{ e.notification.close(); const target=e.notification.data?.url; e.waitUntil((async()=>{ const all=await clients.matchAll({ type:'window', includeUncontrolled:true }); for(const c of all){ if(c.url.includes(BASE)){ c.focus(); if(target) c.navigate(target); return; } } if(target) return clients.openWindow(target); return clients.openWindow(BASE); })()); });
// App-üzenetek → helyi noti
self.addEventListener('message', e=>{ if(e.data&&e.data.type==='notify'&&self.registration.showNotification){ self.registration.showNotification(e.data.title||'FamilyHub',{ body:e.data.body||'' }); }});
`; }

    // ---------- diagnostics ----------
    async function testSW(){ if(!('serviceWorker' in navigator)) { toast('Nincs SW támogatás.'); return; } const isBlob=location.protocol==='blob:'; const isFile=location.protocol==='file:'; const isOpaque=location.origin==='null'; if(isBlob||isFile||isOpaque){ toast('Vászon/Blob/File módban az SW le van tiltva — ez várható.'); return; } try{ const regs=await navigator.serviceWorker.getRegistrations(); if(!regs.length){ toast('Nem található SW regisztráció. (Valós originen fut? sw.js a helyén?)'); return; } const scopes=regs.map(r=>r.scope).join(', '); console.log('Regs:',regs); toast('SW aktív scope-ok: '+scopes); }catch(e){ console.error(e); toast('SW teszt hiba'); } }
    async function unregisterAllSW(){ if(!('serviceWorker' in navigator)) { toast('Nincs SW támogatás.'); return; } try{ const regs=await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); toast('SW(ek) eltávolítva.'); }catch(e){ console.error(e); toast('SW eltávolítás hiba'); } }
    async function clearAllCaches(){ try{ const keys=await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); toast('Cache(ek) ürítve.'); }catch(e){ console.error(e); toast('Cache ürítés hiba'); } }
    function selfTestICS(){ const tmpEvt={ id:id('e'), title:'[TESZT] ICS', start:new Date(), end:new Date(Date.now()+3600000), note:'diagnosztika' }; const backup=[...state.events]; state.events.push(tmpEvt); const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//FamilyHub//HU//','BEGIN:VEVENT','UID:'+tmpEvt.id+'@familyhub']; const dt=d=> new Date(d).toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z'); lines.push('DTSTART:'+dt(tmpEvt.start)); lines.push('DTEND:'+dt(tmpEvt.end)); lines.push('SUMMARY:'+tmpEvt.title); lines.push('DESCRIPTION:'+tmpEvt.note); lines.push('END:VEVENT','END:VCALENDAR'); const text=lines.join('\n'); const ok=text.includes('BEGIN:VEVENT')&&text.includes('DTSTART:')&&text.includes('SUMMARY:'); state.events=backup; toast(ok?'ICS ön-teszt: OK':'ICS ön-teszt: HIBA'); }

    // ---------- header & init ----------
    let deferredPrompt=null; addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; const b=document.getElementById('installBtn'); if(b) b.disabled=false; });
    function bindHeader(){ const b=document.getElementById('installBtn'); if(b) b.onclick=async()=>{ if(!deferredPrompt){ toast('Már telepítve lehet vagy még nem elérhető.'); return; } deferredPrompt.prompt(); }; document.getElementById('notifBtn')?.addEventListener('click', ensureNotifications); document.getElementById('exportBtn')?.addEventListener('click', exportAll); document.getElementById('familyNameLabel').textContent=state.family.name||'Család'; updateNet(); }

    function init(){ load(); bindHeader(); renderTabs('dashboard'); switchView('dashboard'); registerPWA(); }

    return { init };
  })();

  // Boot
  document.addEventListener('DOMContentLoaded', App.init);
  </script>

<!-- ==== BEGIN: Cloud Sync (Firestore) – generic, covers all inputs/selects/textareas/contenteditable ==== -->
<script type="module">
  // --- Firebase v12.4.0 ESM imports ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { 
    getFirestore, enableIndexedDbPersistence, doc, setDoc, getDoc, onSnapshot 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // ====== CONFIG (user-provided) ======
  const firebaseConfig = {
    apiKey: "AIzaSyAheIZeDy24hOHPUvknoIyXKfETnBFMSOs",
    authDomain: "familyhub-6aa6e.firebaseapp.com",
    projectId: "familyhub-6aa6e",
    storageBucket: "familyhub-6aa6e.firebasestorage.app",
    messagingSenderId: "678206075399",
    appId: "1:678206075399:web:e61cd834704fd3dbcef0a2"
  };

  // Egy családi központ – mindenki ugyanazt a dokumentumot szerkeszti
  const HOUSEHOLD_ID = "family_central"; // módosítható
  const PAGE_ID = "daily_core";          // módosítható

  // ====== HELPER ======
  const clientId = (crypto?.randomUUID && crypto.randomUUID()) || ('c' + Math.random().toString(36).slice(2));
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const debounceMap = new Map();
  const isEditable = (el) => el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT' || el.isContentEditable);
  const statusEl = (() => {
    const el = document.createElement('div');
    el.id = 'sync-status';
    el.style.cssText = 'position:fixed;right:10px;bottom:10px;background:#111;color:#fff;padding:8px 10px;border-radius:12px;font:12px/1.2 system-ui,Arial;opacity:.85;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,.3)';
    el.textContent = 'Szinkron inicializálás...';
    document.addEventListener('DOMContentLoaded', () => document.body.appendChild(el));
    return el;
  })();

  function setStatus(msg) {
    if (!statusEl) return;
    statusEl.textContent = '🔄 ' + msg;
  }

  function getKey(el) {
    if (el.id) return 'id:' + el.id;
    if (el.name) return 'name:' + el.name;
    // auto key
    if (!el.dataset.syncKey) {
      el.dataset.syncKey = 'auto_' + Array.from(document.querySelectorAll('[data-sync-key]')).length.toString(36) + '_' + Date.now().toString(36).slice(-4);
    }
    return 'auto:' + el.dataset.syncKey;
  }

  function readValue(el) {
    if (el.tagName === 'INPUT') {
      const t = (el.type || '').toLowerCase();
      if (t === 'checkbox') return { t: 'checkbox', v: !!el.checked };
      if (t === 'radio') {
        // A radio csoport kulcsa a name alapján
        const group = document.querySelectorAll('input[type="radio"][name="' + el.name + '"]');
        const selected = Array.from(group).find(r => r.checked);
        return { t: 'radio', v: selected ? selected.value : null, name: el.name };
      }
      return { t: t || 'text', v: el.value };
    }
    if (el.tagName === 'SELECT') return { t: 'select', v: el.value };
    if (el.tagName === 'TEXTAREA') return { t: 'textarea', v: el.value };
    if (el.isContentEditable) return { t: 'contenteditable', v: el.innerHTML };
    return { t: 'unknown', v: null };
  }

  function applyValue(el, data) {
    if (!data) return;
    if (el.tagName === 'INPUT') {
      const t = (el.type || '').toLowerCase();
      if (t === 'checkbox') el.checked = !!data.v;
      else if (t === 'radio') {
        // radio csoport: name alapján állítjuk
        const group = document.querySelectorAll('input[type="radio"][name="' + el.name + '"]');
        group.forEach(r => r.checked = (r.value === data.v));
      } else {
        el.value = (data.v ?? '');
      }
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
      return;
    }
    if (el.tagName === 'SELECT') {
      el.value = (data.v ?? '');
      el.dispatchEvent(new Event('change', { bubbles: true }));
      return;
    }
    if (el.tagName === 'TEXTAREA') {
      el.value = (data.v ?? '');
      el.dispatchEvent(new Event('input', { bubbles: true }));
      return;
    }
    if (el.isContentEditable) {
      el.innerHTML = (data.v ?? '');
      el.dispatchEvent(new Event('input', { bubbles: true }));
      return;
    }
  }

  function allSyncableElements() {
    const inputs = Array.from(document.querySelectorAll('input, textarea, select, [contenteditable]'));
    return inputs.filter(isEditable);
  }

  async function persist(docRef, key, payload) {
    // Debounce per key
    const old = debounceMap.get(key);
    if (old) clearTimeout(old);
    debounceMap.set(key, setTimeout(async () => {
      try {
        const snap = (await getDoc(docRef));
        const base = snap.exists() ? (snap.data() || {}) : {};
        base[key] = payload;
        await setDoc(docRef, base, { merge: true });
      } catch (e) {
        console.warn('Persist hiba', e);
        setStatus('Mentés hiba (offline?) – újrapróbálkozás automatikus.');
      }
    }, 150));
  }

  // BroadcastChannel – több böngésző fül közötti azonnali jelzés
  const bc = 'BroadcastChannel' in self ? new BroadcastChannel('family_hub_sync') : null;
  function bcPost(msg) { try { bc && bc.postMessage(msg); } catch {} }

  (async () => {
    // Firebase init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Offline perzisztencia
    try { await enableIndexedDbPersistence(db); } catch (e) {
      console.warn('IndexedDbPersistence hiba vagy több tab nyitva – továbbmegyünk online-only módban.', e?.message || e);
    }

    setStatus('Bejelentkezés...');
    try { await signInAnonymously(auth); } catch (e) { console.warn(e); }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      const docRef = doc(db, 'family_hub', HOUSEHOLD_ID + '__' + PAGE_ID);

      // 1) Első beolvasás + snapshot feliratkozás
      setStatus('Adatok betöltése...');
      const initial = await getDoc(docRef).catch(()=>null);
      const state = initial && initial.exists() ? (initial.data() || {}) : {};
      // Alkalmazzuk a DOM-ra
      await sleep(0);
      const els = allSyncableElements();
      for (const el of els) {
        const key = getKey(el);
        if (state[key]) applyValue(el, state[key]);
      }
      setStatus('Szinkron aktív');

      // Élő snapshot
      onSnapshot(docRef, (snap) => {
        const data = (snap.exists() ? (snap.data() || {}) : {});
        const els = allSyncableElements();
        for (const el of els) {
          const key = getKey(el);
          const payload = data[key];
          if (!payload) continue;
          // Ne írjuk vissza a saját frissítést feleslegesen
          if (payload.by && payload.by === clientId) continue;
          applyValue(el, payload);
        }
      });

      // 2) Eseményfigyelők – minden elemre
      const attachListeners = () => {
        const els = allSyncableElements();
        els.forEach(el => {
          const key = getKey(el);

          const handler = () => {
            const val = readValue(el);
            const payload = { ...val, ts: Date.now(), by: clientId };
            persist(docRef, key, payload);
            bcPost({ type: 'local-change', key, payload });
          };

          if (el.tagName === 'INPUT') {
            const t = (el.type || '').toLowerCase();
            if (t === 'checkbox' || t === 'radio') el.addEventListener('change', handler);
            else el.addEventListener('input', handler);
          } else if (el.tagName === 'SELECT') el.addEventListener('change', handler);
          else if (el.tagName === 'TEXTAREA' || el.isContentEditable) el.addEventListener('input', handler);
        });
      };

      attachListeners();

      // Ha DOM dinamikusan változik, újrahook-olunk
      const mo = new MutationObserver(() => {
        attachListeners();
      });
      mo.observe(document.documentElement, { childList: true, subtree: true, attributes: true });

      // BroadcastChannel – ha másik fülben változás történik, frissítés lokálisan is
      if (bc) {
        bc.onmessage = (evt) => {
          const { type, key, payload } = evt.data || {};
          if (type === 'local-change') {
            const els = allSyncableElements();
            for (const el of els) {
              if (getKey(el) === key) applyValue(el, payload);
            }
          }
        };
      }
    });
  })();
</script>
<style>
  /* tiny polish for contenteditable focus */
  [contenteditable]:focus { outline: 2px solid rgba(0,120,255,.35); border-radius: 6px; }
</style>
<!-- ==== END: Cloud Sync (Firestore) ==== -->
</body>
</html>
