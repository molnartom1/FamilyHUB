<!DOCTYPE html>
<html lang="hu">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#0ea5e9" />
<title>FamilyBoard v11d-final</title>
<link rel="manifest" href="./manifest.webmanifest?v=11d-final" />
<style>
  /* A teljes kor√°bbi st√≠lus itt j√∂n, a modern, reszponz√≠v, letisztult design */
  /* P√©ld√°ul az el≈ëz≈ë p√°r √ºzenetben elk√ºld√∂tt css */
</style>
</head>

<body>
<header>Family Board</header>

<button id="darkModeToggle" aria-label="S√∂t√©t m√≥d kapcsol√≥" title="S√∂t√©t m√≥d v√°lt√≥">Dark Mode</button>

<div id="app" class="center">
  <div id="calendar-header">
    <button id="prevMonth" aria-label="El≈ëz≈ë h√≥nap" title="El≈ëz≈ë h√≥nap">&lt;</button>
    <span id="currentMonthYear" aria-live="polite"></span>
    <button id="nextMonth" aria-label="K√∂vetkez≈ë h√≥nap" title="K√∂vetkez≈ë h√≥nap">&gt;</button>
  </div>
  <div id="calendar"></div>

  <div class="card" aria-label="Teend≈ë lista">
    <h2>üìã Teend≈ëk</h2>
    <div class="row">
      <input type="text" id="taskInput" placeholder="√öj teend≈ë‚Ä¶" aria-label="√öj teend≈ë" />
      <input type="time" id="taskTime" aria-label="Id≈ë (HH:MM)" />
      <button id="addTask" title="Hozz√°ad√°s">+</button>
    </div>
    <ul id="taskList" tabindex="0"></ul>
  </div>

  <div class="card" aria-label="Bev√°s√°rl√≥lista">
    <h2>üõí Bev√°s√°rl√≥lista</h2>
    <div class="row">
      <input type="text" id="shoppingInput" placeholder="√öj t√©tel‚Ä¶" aria-label="√öj t√©tel" />
      <button id="addShopping" title="Hozz√°ad√°s">+</button>
    </div>
    <ul id="shoppingList" tabindex="0"></ul>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInAnonymously,
    setPersistence,
    browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import {
    getFirestore,
    enableIndexedDbPersistence,
    collection,
    addDoc,
    query,
    orderBy,
    onSnapshot,
    deleteDoc,
    doc,
    getDocs
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  document.addEventListener("DOMContentLoaded", () => {
    const firebaseConfig = {
      apiKey: "AIzaSyAeoxtOe5Cleasm3KdeSHP9WDR3PkU-N1I",
      authDomain: "mosas-nyilvantartas.firebaseapp.com",
      projectId: "mosas-nyilvantartas",
      storageBucket: "mosas-nyilvantartas.firebasestorage.app",
      messagingSenderId: "38259241645",
      appId: "1:38259241645:web:26070b1d0686def9f00c24"
    };
    initializeApp(firebaseConfig);
    const auth = getAuth();
    setPersistence(auth, browserLocalPersistence);
    const db = getFirestore();
    enableIndexedDbPersistence(db).catch(() => {});

    const householdId = "default";

    // DOM elemek
    const calendarElem = document.getElementById("calendar");
    const currentMonthYearSpan = document.getElementById("currentMonthYear");
    const prevMonthBtn = document.getElementById("prevMonth");
    const nextMonthBtn = document.getElementById("nextMonth");
    const taskInput = document.getElementById("taskInput");
    const taskTime = document.getElementById("taskTime");
    const addTask = document.getElementById("addTask");
    const taskList = document.getElementById("taskList");
    const shoppingInput = document.getElementById("shoppingInput");
    const addShopping = document.getElementById("addShopping");
    const shoppingList = document.getElementById("shoppingList");
    const toggleBtn = document.getElementById("darkModeToggle");
    const rootElem = document.documentElement;

    let selectedDate = new Date();
    let selectedYear = selectedDate.getFullYear();
    let selectedMonth = selectedDate.getMonth();
    let monthItemsCount = new Map();

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function updateCurrentMonthYear(year, month) {
      const date = new Date(year, month, 1);
      const str = date.toLocaleDateString("hu-HU", { year: "numeric", month: "long" });
      currentMonthYearSpan.textContent = str;
    }

    async function loadMonthItemsCount(year, month) {
      monthItemsCount.clear();
      const tasksRef = collection(db, `households/${householdId}/tasks`);
      const shoppingRef = collection(db, `households/${householdId}/shopping`);
      const monthStr = `${year}-${String(month + 1).padStart(2, "0")}`;

      await Promise.all([
        getDocs(tasksRef).then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.date && data.date.startsWith(monthStr)) {
              monthItemsCount.set(data.date, (monthItemsCount.get(data.date) || 0) + 1);
            }
          });
        }),
        getDocs(shoppingRef).then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.date && data.date.startsWith(monthStr)) {
              monthItemsCount.set(data.date, (monthItemsCount.get(data.date) || 0) + 1);
            }
          });
        })
      ]);
    }

    async function createCalendar(year, month) {
      await loadMonthItemsCount(year, month);
      calendarElem.innerHTML = "";
      const daysOfWeek = ["H", "K", "Sze", "Cs", "P", "Szo", "V"];
      daysOfWeek.forEach(day => {
        const header = document.createElement("div");
        header.textContent = day;
        header.classList.add("day-header");
        calendarElem.appendChild(header);
      });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      const daysInMonth = lastDay.getDate();

      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.classList.add("day");
        calendarElem.appendChild(emptyCell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement("div");
        dayCell.classList.add("day");
        dayCell.textContent = day;

        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        if (monthItemsCount.has(dateStr)) {
          const count = monthItemsCount.get(dateStr);
          const dotContainer = document.createElement("div");
          dotContainer.className = "dot-container";

          const nDots = Math.min(count, 3);
          for (let i = 0; i < nDots; i++) {
            const dot = document.createElement("span");
            dot.className = "dot";
            dotContainer.appendChild(dot);
          }
          dayCell.appendChild(dotContainer);

          if (count > 3) {
            const countSpan = document.createElement("div");
            countSpan.className = "count";
            countSpan.textContent = count;
            dayCell.appendChild(countSpan);
          }
        }

        if (year === selectedYear && month === selectedMonth && day === selectedDate.getDate()) {
          dayCell.classList.add("selected");
        }

        dayCell.addEventListener("click", () => {
          selectedDate = new Date(year, month, day);
          selectedYear = year;
          selectedMonth = month;
          refreshCalendar();
        });

        calendarElem.appendChild(dayCell);
      }
    }

    async function refreshCalendar() {
      updateCurrentMonthYear(selectedYear, selectedMonth);
      await createCalendar(selectedYear, selectedMonth);
      loadTasks();
      loadShopping();
    }

    prevMonthBtn.addEventListener("click", () => {
      selectedMonth--;
      if (selectedMonth < 0) {
        selectedMonth = 11;
        selectedYear--;
      }
      selectedDate = new Date(selectedYear, selectedMonth, 1);
      refreshCalendar();
    });

    nextMonthBtn.addEventListener("click", () => {
      selectedMonth++;
      if (selectedMonth > 11) {
        selectedMonth = 0;
        selectedYear++;
      }
      selectedDate = new Date(selectedYear, selectedMonth, 1);
      refreshCalendar();
    });

    // Dark mode toggle
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) {
      rootElem.setAttribute("data-theme", savedTheme);
    }

    toggleBtn.addEventListener("click", () => {
      const currentTheme = rootElem.getAttribute("data-theme");
      if (currentTheme === "dark") {
        rootElem.removeAttribute("data-theme");
        localStorage.setItem("theme", "light");
      } else {
        rootElem.setAttribute("data-theme", "dark");
        localStorage.setItem("theme", "dark");
      }
    });

    let unsubscribeTasks = null;
    function loadTasks() {
      if (unsubscribeTasks) unsubscribeTasks();
      const tasksRef = collection(db, `households/${householdId}/tasks`);
      const q = query(tasksRef, orderBy("createdAt", "desc"));
      unsubscribeTasks = onSnapshot(q, (snapshot) => {
        const dateStr = formatDate(selectedDate);
        const tasks = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          if (data.date === dateStr) {
            tasks.push({ ...data, docId: doc.id });
          }
        });
        renderTasks(tasks);
      });
    }

    function renderTasks(tasks) {
      taskList.innerHTML = "";
      tasks.forEach((task) => {
        const li = document.createElement("li");
        li.textContent = (task.time ? `[${task.time}] ` : "") + task.text;
        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.title = "T√∂rl√©s";
        delBtn.textContent = "‚úñ";
        delBtn.addEventListener("click", async () => {
          const pin = prompt("Add meg a PIN k√≥dot a t√∂rl√©shez:");
          if (pin !== "2025") {
            alert("Hib√°s PIN k√≥d!");
            return;
          }
          await deleteDoc(doc(db, `households/${householdId}/tasks`, task.docId));
        });
        li.appendChild(delBtn);
        taskList.appendChild(li);
      });
    }

    addTask.addEventListener("click", async () => {
      const text = taskInput.value.trim();
      const time = taskTime.value.trim();
      if (!text) return alert("Adj meg egy teend≈ët!");
      const dateStr = formatDate(selectedDate);
      await addDoc(collection(db, `households/${householdId}/tasks`), {
        text,
        time: time || "",
        date: dateStr,
        createdAt: Date.now(),
      });
      taskInput.value = "";
      taskTime.value = "";
    });

    let unsubscribeShopping = null;
    function loadShopping() {
      if (unsubscribeShopping) unsubscribeShopping();
      const shoppingRef = collection(db, `households/${householdId}/shopping`);
      const q = query(shoppingRef, orderBy("createdAt", "desc"));
      unsubscribeShopping = onSnapshot(q, (snapshot) => {
        const items = [];
        snapshot.forEach((doc) => {
          items.push({ ...doc.data(), docId: doc.id });
        });
        renderShopping(items);
      });
    }

    function renderShopping(items) {
      shoppingList.innerHTML = "";
      items.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = item.text;
        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.title = "T√∂rl√©s";
        delBtn.textContent = "‚úñ";
        delBtn.addEventListener("click", async () => {
          const pin = prompt("Add meg a PIN k√≥dot a t√∂rl√©shez:");
          if (pin !== "2025") {
            alert("Hib√°s PIN k√≥d!");
            return;
          }
          await deleteDoc(doc(db, `households/${householdId}/shopping`, item.docId));
        });
        li.appendChild(delBtn);
        shoppingList.appendChild(li);
      });
    }

    addShopping.addEventListener("click", async () => {
      const text = shoppingInput.value.trim();
      if (!text) return alert("Adj meg egy bev√°s√°rl√≥ t√©telt!");
      await addDoc(collection(db, `households/${householdId}/shopping`), {
        text,
        createdAt: Date.now(),
      });
      shoppingInput.value = "";
    });

    async function init() {
      await signInAnonymously(auth);
      refreshCalendar();
      loadTasks();
      loadShopping();
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        init();
      } else {
        signInAnonymously(auth);
      }
    });
  });
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js?v=11d-final");
  }
</script>

</body>

</html>
