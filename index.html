<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>FamilyBoard v11d-final</title>
  <link rel="manifest" href="./manifest.webmanifest?v=11d-final" />
  <style>
    :root {
      --primary: #0ea5e9;
      --bg: #f6f8fb;
      --card: #fff;
      --text: #222;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
    }
    header {
      background: var(--primary);
      color: #fff;
      text-align: center;
      padding: 14px;
      font-weight: 700;
      font-size: 18px;
    }
    .center {
      max-width: 520px;
      margin: 24px auto;
    }
    .card {
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .muted {
      color: var(--muted);
    }
    input[type="text"],
    input[type="time"] {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 16px;
    }
    input[type="text"] {
      flex: 1;
    }
    input[type="time"] {
      width: 98px;
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 16px;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
    }
    button.ghost {
      background: #fff;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    ul {
      list-style: none;
      padding: 0;
      margin-top: 12px;
    }
    li {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }
  </style>
</head>

<body>
<header>Family Board</header>

<div id="app" class="center">
  <div class="card" style="margin-top:16px">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">ðŸ“‹ TeendÅ‘k</h2>
      <div class="row" style="flex:0 0 auto">
        <input type="text" id="taskInput" placeholder="Ãšj teendÅ‘â€¦" />
        <input type="time" id="taskTime" aria-label="IdÅ‘ (HH:MM)" />
        <button id="addTask" title="HozzÃ¡adÃ¡s">+</button>
      </div>
    </div>
    <ul id="taskList"></ul>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInAnonymously,
    setPersistence,
    browserLocalPersistence,
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import {
    getFirestore,
    enableIndexedDbPersistence,
    collection,
    addDoc,
    query,
    orderBy,
    onSnapshot,
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAeoxtOe5Cleasm3KdeSHP9WDR3PkU-N1I",
    authDomain: "mosas-nyilvantartas.firebaseapp.com",
    projectId: "mosas-nyilvantartas",
    storageBucket: "mosas-nyilvantartas.firebasestorage.app",
    messagingSenderId: "38259241645",
    appId: "1:38259241645:web:26070b1d0686def9f00c24"
  };

  initializeApp(firebaseConfig);
  const auth = getAuth();
  setPersistence(auth, browserLocalPersistence);
  const db = getFirestore();
  enableIndexedDbPersistence(db).catch(() => {});

  const householdId = "default";

  // --- Notification permission kÃ©rÃ©s ---
  async function requestNotificationPermission() {
    if (!("Notification" in window)) {
      alert("Ez a bÃ¶ngÃ©szÅ‘ nem tÃ¡mogatja az Ã©rtesÃ­tÃ©seket.");
      return false;
    }
    if (Notification.permission === "granted") return true;
    if (Notification.permission !== "denied") {
      const permission = await Notification.requestPermission();
      return permission === "granted";
    }
    return false;
  }

  // --- Local notification megjelenÃ­tÃ©s ---
  function showLocalNotification(title, body) {
    if (Notification.permission !== "granted") return;
    new Notification(title, {
      body,
      icon: "icons/icon-192.png",
    });
  }

  // --- HTML elemek ---
  const taskInput = document.getElementById("taskInput");
  const taskTime = document.getElementById("taskTime");
  const addTask = document.getElementById("addTask");
  const taskList = document.getElementById("taskList");

  // --- TeendÅ‘k megjelenÃ­tÃ©se ---
  function renderTasks(tasks) {
    taskList.innerHTML = "";
    tasks.forEach((task) => {
      const li = document.createElement("li");
      li.textContent = (task.time ? "[" + task.time + "] " : "") + task.text;
      taskList.appendChild(li);
    });
  }

  // --- TeendÅ‘k betÃ¶ltÃ©se Ã©s listen ---
  function listenTasks() {
    const tasksRef = collection(db, `households/${householdId}/tasks`);
    const q = query(tasksRef, orderBy("createdAt", "desc"));
    return onSnapshot(q, (snapshot) => {
      const todos = [];
      snapshot.forEach((doc) => {
        todos.push(doc.data());
      });
      renderTasks(todos);
    });
  }

  // --- Ãšj teendÅ‘ hozzÃ¡adÃ¡sa ---
  addTask.addEventListener("click", async () => {
    const text = taskInput.value.trim();
    const time = taskTime.value.trim();
    if (!text) return alert("Adj meg egy teendÅ‘t!");
    await addDoc(collection(db, `households/${householdId}/tasks`), {
      text,
      time: time || "",
      createdAt: Date.now(),
    });
    showLocalNotification("Ãšj teendÅ‘", `Feladat: ${text}`);
    taskInput.value = "";
    taskTime.value = "";
  });

  // --- AlkalmazÃ¡s indÃ­tÃ¡sa ---
  async function init() {
    await signInAnonymously(auth);
    await requestNotificationPermission();
    listenTasks();
  }

  onAuthStateChanged(auth, (user) => {
    if (user) {
      init();
    } else {
      signInAnonymously(auth);
    }
  });
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js?v=11d-final");
  }
</script>

</body>
</html>
